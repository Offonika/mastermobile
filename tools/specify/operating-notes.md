# Operating Notes — «Ассистент мастера» v0.1

> Эксплуатационные требования и конвенции. Ссылается на PRD ([ссылка](../../docs/PRD%20%E2%80%94%20%C2%AB%D0%90%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B0%C2%BB.md)) и One-Pager ([ссылка](../../docs/ONE-PAGER%20%E2%80%94%20%D0%90%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B0%20v0.1.md)).

## 1. SLO/SLA и производительность
- **API Bitrix:** p95 < 250 мс на вызов (выполняется за счёт близкого размещения бекенда и Bitrix, использования HTTP keep-alive и минимизации payload).
- **Бот (end-to-end без STT):** p95 < 250 мс, p99 < 500 мс. STT добавляет до 5 c (по PRD), учитывается отдельно.
- **Таймауты:** 3 c на внешние вызовы Bitrix; глобальный deadline обработки сообщения Telegram — 8 c.
- **Ретраи:** максимум 2 повтора с экспоненциальным backoff 250/500 мс + jitter. Повторы только для 5xx/сетевых ошибок.

## 2. Надёжность и идемпотентность
- **Idempotency-Key:** обязателен для `order`, `cart/add`, `rma`. Ключ — UUID v4, сохраняется 72 ч, проверяется на совпадение тела.
- **Webhooks:** проверяем подпись `X-Webhook-Signature`, TTL события 5 мин, дедупликация по `event_id`.
- **Circuit breaker:** отдельные «полюса» на поиск и платёжные операции (состояние degraded передаётся в метрику `degraded_mode_on`).
- **Fallback режим:** при недоступности поиска > 30 с выдаётся кеш ответа (TTL 60 с), скрываются действия «Заказать/Неси», отправляется уведомление пользователю (см. PRD §5).
- **Логи:** маскирование PII (имя, телефон, адрес). Поля: `request_id`, `telegram_user_id`, `intent`, `bitrix_status`, `latency_ms`, `retry_count`.

## 3. Мониторинг и алерты
- **Метрики:** latency p50/p95/p99, error rate, `no_result`, `clarifications`, `conversion`, `cod_share`, `degraded_mode_on`, количество ретраев, STT ошибки.
- **Дашборд:** отдельные панели по поиску, заказам, RMA, вебхукам.
- **Алерты:**
  - `/api/v1/search` p95 > 2.0 c в течение 15 мин.
  - `/api/v1/order` error rate > 3% (15 мин).
  - `no_result` > 12% за 24 ч.
  - `degraded_mode_on` = true дольше 10 мин.
  - Ошибки авторизации Bitrix > 5 подряд за 5 мин.

## 4. Локализация и контент
- **Основной язык:** ru-RU. Переключение языка планируется в v0.2; все тексты вынести в словарь `locales/ru-RU.yaml`.
- **Формат времени:** ISO-8601 с таймзоной, как задано в [00-Core](../../docs/00%E2%80%91Core%20%E2%80%94%20%D0%A1%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8.md#2-core-api-style-v1).
- **Бизнес-термины:** использовать словарь статусов и наименований из 00-Core; новые статусы согласовывать перед добавлением.
- **Кнопки Telegram:** текст ≤ 24 символов, emoji допускаются только для подсказок.

## 5. Безопасность и соответствие
- **Хранение аудио:** 7–30 дней (конфиг), автоматическое удаление по расписанию.
- **PII:** маскирование в логах, ограничение доступа к хранилищам через RBAC.
- **Секреты:** `BOT_TOKEN`, `SITE_API_BASE_URL`, `WEBHOOK_SECRET`, `JWT_PUBLIC_KEY`, `TELEMETRY_DSN` — в Secret Manager; ротация каждые 90 дней.
- **Rate limits:** 60 запросов/час на пользователя, burst 10; `/order` ≤ 5/мин; `/rma` ≤ 3/день.
- **Audit trail:** записывать действия админов (изменение настроек, обновление токенов).

## 6. Запуск и поддержка
1. Подготовить stage Bitrix-портал и подключить webhook.
2. Пройти UAT-чеклист из One-Pager (100 реальных запросов, 20 негативных кейсов).
3. Настроить CI/CD: авторазвёртывание FastAPI, smoke-тест «поиск → заказ → трекинг».
4. Обновить карту версий в `docs/00‑Core — Синхронизация документации.md`.
5. Перед релизом зафиксировать owners: продукт, техлид бота, техлид интеграции.
