# Blueprint — «Ассистент мастера» v0.1

> Краткий обзор целевого решения. Использует PRD и One-Pager как источники: см. [PRD](../../docs/PRD%20%E2%80%94%20%C2%AB%D0%90%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B0%C2%BB.md) и [One-Pager](../../docs/ONE-PAGER%20%E2%80%94%20%D0%90%D1%81%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BD%D1%82%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B0%20v0.1.md).

## 1. Обзор
- **Название:** «Ассистент мастера» MasterMobile (v0.1).
- **Цель:** предоставить мастерам быстрый канал в Telegram для поиска деталей, оформления заказов (предоплата/«неси»), отслеживания статусов и возвратов, а также кратких техподсказок без собственной БЗ на старте.
- **Каналы:** Telegram (чат/кнопки, поддержка голоса через STT), FastAPI-бекенд, Bitrix REST API (интернет-магазин).
- **Основной happy-path:** поиск → выбор SKU → оформление (prepaid/«неси») → трекинг статуса заказа.

## 2. Роли и контекст использования
| Роль | Потребность | Основные действия |
| --- | --- | --- |
| **Мастер** | Быстро найти запчасть, оформить заказ, отслеживать статус, оформить возврат, получить техподсказку. | `/find`, карточки, «Заказать» или «Неси», `/track`, `/return`, `/howto` |
| **Менеджер магазина** | Следить за заказами, подтверждать оплату/COD, обрабатывать RMA, модерировать подсказки. | Админ-интерфейсы Bitrix, вебхуки статусов |
| **Админ (тех/продукт)** | Управление ботом, настройка интеграций, мониторинг SLA/SLO. | Управление токенами, логами, алертами |

## 3. Пользовательские сценарии (v0.1)
1. **Поиск и заказ с предоплатой.** Мастер отправляет «Найди экран на iPhone 11». Бот нормализует запрос, вызывает Bitrix search, показывает карточки. Пользователь выбирает SKU, нажимает «Заказать», подтверждает и получает ссылку на оплату. После оплаты приходит уведомление о статусе.
2. **Поиск и заказ «Неси».** Мастер просит «Неси 2 аккумулятора на A52, чёрные». Бот уточняет адрес при необходимости, оформляет заказ с оплатой при получении, курьерская служба отправляет обновления.
3. **Трекинг.** Команда `/track 24581` возвращает текущее состояние заказа, ETA и историю событий.
4. **RMA.** Команда `/return 1789 — дисплей брак` регистрирует возврат с фотографиями, выдаёт номер RMA и далее синхронизируется со статусами Bitrix.
5. **Техподсказки.** `/howto замена стекла камеры A52` выдаёт 4–6 шагов, инструменты и риски, а также кнопку «Заказать комплект».

## 4. Архитектура решения
```
Telegram Bot API ──(webhook)──► FastAPI backend ──► Bitrix REST (поиск/цены/остатки/заказы/RMA)
                                      │
                                      ├─► Prompt NLU (extract intent/entities)
                                      ├─► Rate limiting, logging, metrics (OpenTelemetry optional)
                                      └─► Webhooks handler (order/payment/delivery)
```
- **Telegram webhook**: FastAPI endpoint `/webhook/telegram` принимает обновления, валидирует подпись, маршрутизирует по командам.
- **NLU (prompt-only)**: извлекает сущности (модель, деталь, qty, качество, цвет, город) и определяет намерение.
- **Bitrix REST**: основной источник данных — каталог, цены, остатки, заказы, статусы, RMA. 1С в v0.1 не задействуется.
- **Хранилища**: состояние корзины и идемпотентности — в FastAPI/Redis (при наличии); persistent хранение не требуется.
- **Локализация**: ru-RU по умолчанию, тексты кнопок/сообщений — из словаря с возможностью расширения.

## 5. Happy-path последовательность (prepaid)
1. **Инициирование** — мастер отправляет запрос через Telegram.
2. **Webhook** — FastAPI получает апдейт, валидирует пользователя (JWT из Telegram Login Widget).
3. **NLU** — промт выделяет сущности и формирует параметры поиска.
4. **Поиск** — запрос к `POST /rest/catalog.search` (см. `bitrix-integration.md`) с параметрами.
5. **Карточки** — бот отображает 3–5 вариантов с кнопками «В корзину», «Заказать», «Неси».
6. **Оформление** — при выборе «Заказать» бекенд подтверждает актуальность цены/остатка и вызывает `POST /rest/order.add` с `payment=prepaid`.
7. **Оплата** — ссылка из Bitrix передаётся мастеру; по подтверждению приходит вебхук `payment.status.changed`.
8. **Трекинг** — бот показывает текущий статус из `GET /rest/order.get` и подписывается на обновления `delivery.tracking.update`.

## 6. Ограничения и решения
- **Без собственной БЗ** — техподсказки формируются промтом, не хранится самостоятельный контент.
- **Производительность** — целевой P95 < 250 мс на запрос к бекенду (без учёта STT); Bitrix вызовы кешируются минимально, используются параллельные батчи для цен/остатков.
- **Надёжность** — ретраи с экспоненциальным backoff, идемпотентность через `Idempotency-Key`, логирование с маскированием PII, контролируемые rate limits.
- **Расширяемость** — структура допускает подключение RAG-lite для поиска в v0.2 без изменения каналов взаимодействия.

## 7. Готовность к зеркалированию
- Именование файлов соответствует будущему размещению в `docs/spec/assistant-master/`.
- Ссылки на исходные документы относительные и корректно разрешаются при переносе.
- Структура документа: обзор → роли/сценарии → архитектура → happy-path → ограничения — соответствует формату Spec Kit.
