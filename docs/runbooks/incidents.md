<!-- filename: docs/runbooks/incidents.md -->

<!-- docs/runbooks/incidents.md -->
# Incident Response Runbook

## Цель
Обеспечить предсказуемый и быстрый отклик на инциденты middleware MasterMobile, снизить время
простоя и сохранить целостность данных.

## Классификация инцидентов
| Уровень | Критерии | SLA реакции |
|---------|----------|-------------|
| SEV-1   | Полная недоступность API или критичная потеря данных | 5 минут |
| SEV-2   | Частичная деградация (ошибки ≥ 10%, задержки > p95 SLO) | 15 минут |
| SEV-3   | Локальные проблемы функционала, отсутствие влияния на ядро | 60 минут |

## Общий процесс
1. **Детекция** — алерты из мониторинга (Grafana, Sentry, uptime-боты) или ручное сообщение.
2. **Подтверждение** — on-call инженер фиксирует номер инцидента в трекере (Jira/Notion) и
   определяет уровень SEV.
3. **Коммуникация** — уведомление каналов `#ops-alerts`, `#product-alerts`, указание ответственных
   и времени следующего апдейта.
4. **Диагностика** — сбор логов (`docker compose logs app`, Sentry breadcrumbs), метрик,
   воспроизведение ошибки.
5. **Митигация** — временное решение (rollback, feature-flag, масштабирование), фиксация в тикете.
6. **Решение** — применение постоянного фикса, подтверждение восстановления метрик.
7. **Postmortem** — анализ причин, действия для предотвращения повторения, обновление документации.

## Детализация этапов
### Детекция и подтверждение
- Проверить `open incidents` в PagerDuty/Rotation-календаре.
- Собрать минимум данных: время начала, затронутые клиенты, симптомы.
- Если инцидент SEV-1 — задействовать продакт-менеджера и руководство сразу.

### Диагностика
- **API**: `curl https://prod.example.com/health`, проверить статус и версию.
- **База данных**: `SELECT now(), count(*) FROM pg_stat_activity WHERE state != 'idle';`.
- **Redis**: `redis-cli -h <host> llen <queue>`.
- Сверить с последними релизами (`git log --oneline --since="2 hours ago"`).

### Митигация
- Rollback по runbook деплоя (`deploy.md`) или отключение проблемного функционала через feature flag.
- Ограничение нагрузки: временно увеличить ресурсы или включить rate limiting.
- Документировать временные решения и потенциальные риски.

### Коммуникация
- Обновлять статус каждые 15 минут (SEV-1/2) или 30 минут (SEV-3).
- После завершения инцидента отправить финальный отчёт с таймлайном и действиями.

### Postmortem
- Создать документ в `docs/adr/` с анализом, если требуется архитектурное решение.
- Обновить runbook (этот файл), тестовую стратегию или другие документы по итогам инцидента.
- Добавить сценарии воспроизведения в `docs/testing/strategy.md` и ошибки в `error_catalog.json`.

## Шаблон отчёта
```
Инцидент: INC-YYYYMMDD-XX
SEV: 1/2/3
Время обнаружения: HH:MM TZ
Время решения: HH:MM TZ
Описание: ...
Корневая причина: ...
Временные меры: ...
Постоянные меры: ...
Follow-up задачи: ...
Ответственные: ...
```

## Контакты
- On-call инженер: `@team-ops`
- Архитектор middleware: `@team-arch`
- Продакт: `@team-product`
- Безопасность/PII: `@team-security`
