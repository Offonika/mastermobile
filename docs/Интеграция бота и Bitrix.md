Интеграция бота и Bitrix — финал v1
1) Источник истины и охват

SoT: Bitrix (каталог, цены, остатки, заказы, статусы, платёжные ссылки).

1С не подключаем (на v1), вся логика — по данным сайта.

Склады: используем текущие остатки из каталога (мульти-склады не раскрываем клиенту в v1).

Резервирование: при оформлении заказа, авто-снятие через 3 дня (как в настройках).

2) Роли/цены (из Битрикс)

Розница (база): REGISTERED_USERS → тип цены Розница (ID=13).

Опт-группы:

Бронзовый: REGISTERED_USERS_OPT2 → 2.Бронзовый (ID=10)

Серебряный: REGISTERED_USERS_OPT3 → 3.Серебряный (ID=9)

Золотой: REGISTERED_USERS_DILER → 4.Золотой (ID=5)

В боте цена и скидки = ровно тот тип цены, который назначен пользователю в Битрикс (без агрегации).

3) Пользователь и авторизация

Линк бота ↔ сайт через телефон/e-mail (код подтверждения) → маппим на Bitrix user_id.

При каждой операции бот передаёт user_id — Bitrix отдаёт цены/права по группам.

Неавторизованный пользователь видит Розницу.

4) Функции бота v1

Поиск запчастей (текст/голос): бренд/модель/тип/качество/цвет.

Карточки 3–5 позиций: название, качество, цена по типу пользователя, «в наличии / мало / нет».

Корзина: добавить/изменить/удалить.

Оформление:

/order — предоплата (CloudPayments → платёжная ссылка).

/bring — «Неси» (наложенный / COD) — создаём заказ в статусе «не оплачен».

Мои заказы / трекинг: статус, сумма, ссылка на оплату (если актуально).

Мини-RMA: регистрация запроса и фото (заявка в Bitrix/CRM-сущность или в comments к заказу).

Короткие тех-подсказки (промт, без RAG).

5) Протокол интеграции (MW ⇄ Bitrix)

Бот говорит только с нашим middleware (MW). MW идёт в Bitrix REST/компоненты Б24/внутренние скрипты.

5.1 Контракты MW (стабильно)
POST /bot/find        { q, brand?, model?, part?, quality?, color?, page?, user_id? }
→ { items:[{sku,title,brand,model,quality,color,price,stock_tag,thumb,url}] }

POST /bot/cart/add    { user_id, sku, qty }
→ { cart_id, items_count, amount }

POST /bot/cart/get    { user_id }
→ { items:[{sku,title,qty,price,amount}], amount }

POST /bot/order       { user_id, items[], payment:"prepaid"|"cod", address?, comment? }
→ { order_id, status, payment_url? }

GET  /bot/orders      { user_id }
→ { orders:[{id,date,status,amount,payment_url?}] }

POST /bot/rma         { user_id, order_id, items[], photos[] }
→ { rma_id, status }


Требования: Idempotency-Key на order, повторная проверка цены/остатка перед созданием.

5.2 Что делает MW внутри

Поиск: вызывает метод каталога Bitrix (поиск по названию/артикулам/свойствам), нормализует поля, прикладывает цену по типу (см. §2).

Корзина: хранение в Bitrix (если модуль корзины подключён) или в MW (краткоживущая сессия) с обязательной валидацией при заказе.

Заказ: создаёт заказ в Bitrix:

Резерв: включён на момент оформления.

Оплата:

prepaid → формируется ссылка CloudPayments (из платёжной системы ID 21/22), заказ остаётся «не оплачен» до callback.

cod → создаётся без оплаты («Не оплачен»).

Статусы: показываем клиенту человекочитаемые (пример):

N Не оплачен → P Оплачен → F Выполнен / доставлен;

CloudPayments-специфичные: AU авторизован, CP подтверждён, RR возврат, AR отмена авто.

Трекинг: возвращаем status, eta?, payment_url?.

6) Платежи/доставка

Платёжные системы в сайте: CloudPayments (двухстадийная оплата поддерживается), «Наличными при получении».

В боте:

Предоплата — ссылка CP; оплата подтверждает заказ (Bitrix переключает в P/далее по автоматизации).

Неси/COD — без ссылки, статус «Не оплачен».

Доставка: используем текущие службы/правила из сайта (ограничения по местоположению уже настроены). В боте запрашиваем адрес/город и передаём в заказ.

7) Лимиты и AI-токены (геймификация)

Включаем AI-подсказки (короткие тех-ответы) с лимитами по «AI-токенам».

План тарификации (настраивается):

Розница: 30 токенов/мес (≈30 коротких ответов).

Бронзовый: 100 /мес, Серебряный: 300 /мес, Золотой: 1000 /мес.

Бонусы: +1 токен за каждые 3 000 ₽ покупок за 30 дней; +20 за предоплату; +10 за успешное RMA.

Храним баланс в MW (ключ user_id), списываем за факт ответа (1 запрос = 1 AI-токен).

8) UX-потоки (как в боте)

Поиск → карточка → корзина → оформление (prepaid/COD).

Мои заказы — список с быстрыми кнопками [Оплатить] [Повторить].

RMA — номер заказа → выбор позиции → загрузка 1–3 фото → заявка.

9) Ошибки, ретраи, мониторинг

Таймаут бота: 8 с, Bitrix-вызовов: 3 с; ретраи 2× с backoff.

Единый формат ошибок: {code,message,hint,correlation_id}.

Метрики (Prometheus/Grafana на MW): latency p95, error-rate, no-result, CTR карточек, conversion find→order, доля COD, оплаты CP.

Алерты: p95 > 5 с (15 мин), order-ошибки > 3% (15 мин), no-result > 12% (сутки).

10) Безопасность/ПДн

Telegram-аккаунт привязываем к Bitrix-пользователю через одноразовый код (телефон/e-mail).

Маскирование PII в логах, HMAC подписи вебхуков CloudPayments, X-Request-Id.

Retention: чаты/логи 30 дней, платежные события согласно политикам сайта.

11) Приёмочные критерии (UAT)

Цены в боте = цены сайта для 4 эталонных пользователей (Розница/Бронза/Серебро/Золото).

Резерв ставится при оформлении; автоматическое снятие через 3 дня не ломает статусы.

Prepaid: ссылка CP работает, оплата меняет статус на «Оплачен», заказ виден в «Мои заказы».

COD: создаётся «Не оплачен», доступен трекинг.

Точность поиска (golden-set 100 запросов) ≥ 80% F1; no-result ≤ 10%.

Падения/ошибки ≤ 1% за сутки на пилоте (≥300 запросов).

12) Чек-лист настройки в Bitrix (must-have)

 Типы цен ↔ группы (см. итог из предыдущего сообщения) — только «своя» группа в просмотр/покупку.

 Платёжные системы: CloudPayments активна; «Наличными при получении» активна.

 Ограничения оплат/доставок настроены (CloudPayments — только для нужных сайтов/регионов).

 Резервирование: «При оформлении заказа», снятие через 3 дня.

 Автоматизация статусов (опция) — при полной оплате → [P] Оплачен.

 Пользователь состоит только в одной из оптовых групп.

13) План работ (1–2 недели)

W1: каркас бота (Telegram), авторизация, /bot/find, карточки/корзина; чтение цен/остатков c учётом групп.

W2: /bot/order (CP+COD), «Мои заказы», трекинг; лимиты AI-токенов; алерты/метрики; UAT по чек-листу.