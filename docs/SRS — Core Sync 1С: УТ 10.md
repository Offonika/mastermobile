SRS — Core Sync 1С: УТ 10.3 ↔ УТ 11 (без простоя)
 Версия: 1.0.3 (синхронизировано с 00‑Core v1.3.4)
 Дата: 30.09.2025
 Владелец: Операции / IT
Связанные документы: PRD Core Sync v1.1.2 (18.09.2025), ONE‑PAGER (финал), API‑Contracts v1.1.0, ER Freeze v0.6.4

1. Назначение
Техническая спецификация для запуска УТ 11 в параллель с УТ 10.3 и организации надёжного обмена данными. На старте SoT = УТ 10.3, далее перевод мастера по объектам «волнами», без простоя. Сайт (1С‑Битрикс) остаётся на стандартном обмене и будет переключён на УТ 11 после стабилизации.

2. Объём (Scope), допущения, ограничения
Входит (v1): первичная загрузка НСИ (КД3), дельты НСИ (REST/JSON), «зеркало» ключевых документов; документы: Заказ клиента, Реализация, Поступление, Перемещение, Списание, Оприходование, Инвентаризация, Возвраты; ПКО/РКО/Подотчёт; Банк/эквайринг (регламентно). Идемпотентность, журнал интеграции, очереди/ретраи, мониторинг/алерты, безопасность. UAT, cutover, откат.
 Не входит (v1): маркировка/54‑ФЗ/ЭДО; серийники/IMEI/партии/сроки; маршрутизация/GPS/ML; изменения схемы обмена сайта.
 Допущения: 1С 8.3.x; стандартный обмен сайта (CommerceML/REST) без кастомизаций; инфраструктура под MW/БД/резервирование доступна с W1.

3. Заинтересованные стороны и роли
Product Owner (Операции/IT) — приоритеты, SoT, решения по cutover.


Интегратор 1С (10.3/11) — обмен/документы/проводки.


Backend (MW) — API/очереди/идемпотентность/логи.


Bitrix CMS (сайт) — стандартный обмен и cutover базы‑источника.


QA/DevOps — тесты, мониторинг, релиз/откат.



4. Окружения
DEV → TEST → UAT → PROD; анонимизация тест‑данных; отдельные ключи/секреты по окружениям.

5. Общая архитектура и потоки
УТ 10.3 ↔ Middleware (FastAPI) ↔ УТ 11: обмен НСИ/документами.
 Сайт ↔ 1С: стандартный обмен (источник: старт — УТ 10.3, после cutover — УТ 11).
 Надёжность: TLS, Bearer/JWT, Idempotency‑Key, X‑Correlation‑Id, очереди (retry/backoff), IntegrationLog, health‑чеки.
 Диаграмма (логическая): 10.3 (SoT старт) ➜ MW (API, очередь) ➜ 11 («зеркало» → мастер по волнам). Обратные подтверждения и статусы — через MW.

6. Источник истины (SoT) и SLA дельт
(Таблица идентична PRD Core Sync v1.1.2)
Объект
SoT старт
SoT целевой
Канал
SLA дельт
Номенклатура
10.3
11 (волна 2)
КД3 + API
≤ 60 c
Контрагенты
10.3
11 (2–3)
КД3 + API
≤ 60 c
Склады/ед. изм.
10.3
11
КД3
регл.
Типы цен/цены
10.3
11 (волна 3)
КД3 + API
регл. + дельты
Ставки НДС
10.3
11 (после выверки)
API
по событию
Заказ клиента
10.3 → зеркало
мастер 11 (3+)
API
≤ 120 c
Реализация/Поступление
10.3 → зеркало
мастер 11 (после пилота)
API
≤ 120 c
Перемещение/Списание/Оприходование
10.3
11 (3+)
API
≤ 120 c
Инвентаризация
10.3
11 (после «сухого»)
API
по акту
Возвраты (покуп./пост.)
10.3
11 (3+)
API
≤ 120 c
ПКО/РКО/Подотчёт
10.3
11 (после стаб.)
API
по событию
Банк/эквайринг
10.3
11
API/файлы
дневной
Сайт ↔ 1С
10.3
11 (после cutover)
стандартный обмен
регл.


7. Функциональные требования (FR)
FR‑NSI (НСИ)
FR‑NSI‑001. Bulk‑загрузка НСИ (КД3). Разовая загрузка товаров/контрагентов/складов в 11; протокол несопоставленных — ноль/обработан.


FR‑NSI‑010. Дельты НСИ. Передавать только изменения; p95 доставки ≤ 60 c; поддержка «отложенных» зависимостей (например, тип цены после создания типа цен).


FR‑DOC (Документы)
FR‑DOC‑001. «Зеркало» документов. Заказы/реализация/поступление/перемещение/списание/оприходование/инвентаризация/возвраты — появляются в 11 ≤ 120 c без дублей.


FR‑DOC‑020. Перевод мастера по волнам. Ввод по виду документов переносится в 11 после 2 недель UAT без критичных + акт «0 критичных» + ночной cutover.


FR‑DOC‑030. Конфликты. При разнонаправленных правках побеждает SoT; журнал фиксирует конфликт и правило разрешения.


FR‑CASH (Деньги)
FR‑CASH‑001. ПКО/РКО/Подотчёт. Черновики и статусы синхронизируются; разделение «товар/доставка»; допустимая дельта отчёта «Должен/Сдал» ≤ 0,3%.


FR‑LOG (Наблюдаемость)
FR‑LOG‑001. Журнал интеграции. Лог JSON на каждый вызов (ts, correlation_id, статус, тело/хэш тела). Retention: integration_log ≥ 90 дн; task_events ≥ 180 дн.


FR‑LOG‑010. Дашборды и алерты. Метрики: задержка дельт, %5xx/%4xx, размер очередей, «дубликаты/1000 POST»; пороги warn/crit (см. §10).


FR‑IDEMP (Идемпотентность/очереди)
FR‑IDEMP‑001. Идемпотентность. Повтор с тем же Idempotency‑Key возвращает исходный ответ; TTL окна — 72 часа.


FR‑IDEMP‑010. Очереди/ретраи. Экспоненциальный backoff 1м→5м→15м→1ч→3ч→12ч с джиттером (см. 00‑Core §2.5); гарантированная доставка ≤ 24 ч при кратковременных сбоях.




8. Внешние интерфейсы (API MW)
Контракт v1.1.0 опубликован в `openapi.yaml` и охватывает четыре домена: `system`, `returns`, `b24-calls`, `walking-warehouse`. Спецификация синхронизирована с FastAPI-службой; любые изменения требуют обновления OpenAPI и SRS.

Общие требования:
- Аутентификация — `Authorization: Bearer <JWT>` (роли `1c`, `courier`, `admin`) для операций доменов `returns` и `walking-warehouse`; `/health` и `/api/v1/system/ping` публичны, выгрузки `b24-calls` на текущей итерации не требуют авторизации в контракте и вызываются сервисными интеграциями.
- Идемпотентность — заголовок `Idempotency-Key` обязателен для всех небезопасных операций (`POST`, `PUT`, `PATCH`, `DELETE`) доменов `returns` (включая административные запросы на `/api/v1/b24-calls/export.json`) и `walking-warehouse`; повтор с иным телом → `409 Conflict`.
- Наблюдаемость — заголовок `X-Request-Id` передаётся опционально, echo возвращается сервером; ответы используют `application/json`, `application/problem+json` или `text/csv` для экспортов.

`system` (диагностика MW):
- GET `/health` — проверка доступности, возвращает статус и версию.
- GET `/api/v1/system/ping` — быстрая проверка, дополнительно отдаёт UTC timestamp и диагностические флаги.

`returns` (обмен возвратами между 1С и MW):
- GET `/api/v1/returns` — пагинированная выдача `PaginatedReturns` c фильтрами страницы/размера.
- POST `/api/v1/returns` — регистрация возврата (`ReturnCreate` → `Return`, `Location` в заголовке).
- GET `/api/v1/returns/{return_id}` — получение карточки возврата.
- PUT `/api/v1/b24-calls/export.json` — административное обновление возврата, использует `ReturnCreate` и `Idempotency-Key` (временный путь до миграции `/returns/{id}`).
- DELETE `/api/v1/b24-calls/export.json` — административное удаление возврата (204 при успехе, `Idempotency-Key`).

`b24-calls` (реестр звонков Bitrix24):
- GET `/api/v1/b24-calls/export.csv` — потоковый CSV экспорт с фильтрами `employee_id`, `date_from`, `date_to`, `has_text`.
- GET `/api/v1/b24-calls/export.json` — JSON-выгрузка с теми же фильтрами для аналитики и проверки качества транскриптов.

`walking-warehouse` (курьеры и мгновенные заказы):
- Курьеры: GET `/api/v1/ww/couriers` (поиск по q), POST `/api/v1/ww/couriers` (создание, `Idempotency-Key`).
- Заказы: GET `/api/v1/ww/orders` (фильтры по статусу и поиску), POST `/api/v1/ww/orders` (создание заказа), PATCH `/api/v1/ww/orders/{order_id}` (частичное обновление), POST `/api/v1/ww/orders/{order_id}/assign` (назначение/отвязка курьера), POST `/api/v1/ww/orders/{order_id}/status` (смена статуса).
- Отчётность и интеграции: GET `/api/v1/ww/report/deliveries` (JSON или CSV с итоговой строкой `TOTALS`), GET `/api/v1/ww/export/kmp4` (структура `KMP4ExportResponse` для расширения 1С).
Все операции Walking Warehouse требуют JWT с ролью `courier` или `admin`, кроме создания курьера (`admin`).

Системные проверки: `/health` (status/uptime) и `/api/v1/system/ping` (статус + UTC timestamp, 503 при деградации).

9. Данные и маппинг (см. ER Freeze v0.6.4)
Поле‑в‑поле (таблица в приложении): единицы, НДС, валюты, статусы, округления (цены/суммы — numeric(12,2)), часовые пояса (все метки — UTC).
 Уникальные ключи: GUID 1С (если есть) + составной ключ (№+дата+организация+склад) + md5(payload) для дедупа.
 Правила конфликтов: при расхождении — приоритет SoT; матрица статусов заказа (приложение) для конвертации 10.3↔11.
 Домены: currency_code (RUB), телефон (если присутствует) +7XXXXXXXXXX.

10. Нефункциональные требования (NFR), лимиты и SLO
Производительность: p95 для MW ≤ 400 мс (без внешних вызовов); целевой throughput до 50 rps, burst 100 rps (≤60 c).
 SLO per объект: НСИ ≤ 60 c; Документы ≤ 120 c; ПКО ≤ 180 c. Еженедельный error‑budget: 5xx ≤ 0,1%.
 Лимиты API: payload ≤ 2 MB; batch ≤ 500 строк; таймаут к внешним 10 c; retry 1м→5м→15м→1ч→3ч→12ч (см. 00‑Core §2.5, джиттер).
 Доступность: MW ≥ 99,9% (месяц, 43 мин простоя). RPO ≤ 5 мин, RTO ≤ 15 мин.
 Безопасность: TLS 1.2+; Bearer/JWT; маскирование телефонов/адресов в логах; хранение секретов в менеджере секретов; шифрование бэкапов.
 Наблюдаемость: дашборды (задержка дельт, очереди, %5xx/%4xx, дубликаты/1000); алерты — warn (>10 мин задержки НСИ), crit (>30 мин; %5xx>0,1%/15 мин; очередь>10k).
 Retention: integration_log ≥ 90 дн; task_events ≥ 180 дн; idempotency_key TTL 72 ч.

11. Миграция, cutover и откат
Миграция: КД3 snapshot → прогон дельт → короткое freeze → cutover (перевод мастера по виду).
 Cutover (Go/No‑Go): UAT pass‑rate ≥ 98% (7 дней), дельты p95 ≤ 120 c, акт «0 критичных», мониторинг зелёный 48 ч на стенде, готов план отката и on‑call.
 Откат: переключение флажка мастера назад, реплей очередей, возврат на snapshot; оповещение стейкхолдеров.

12. Тест‑план (выжимка)
Позитивные: bulk НСИ; дельты НСИ; зеркало всех документов; ПКО/РКО; сверки по выборке.
 Негативные/edge: повторный POST с иным телом (ожидаем 409); конфликт статусов (побеждает SoT); оффлайн‑реплей без дублей; частичный возврат с иной ставкой НДС; «тяжёлые» партии (batch=500).
 Performance/failover: x2 «пик»; отказ внешних (имитация 429/504); рост очередей и корректная отработка ретраев.
 UAT чек‑листы — в приложении.

13. Развёртывание (CI/CD)
Автоматический деплой MW (blue‑green/rolling) с health‑чеками и авто‑откатом при деградации SLO.
 Версионирование API — префикс `/api/v1`; минорные релизы добавляют поля без ломающих изменений.

14. Риски и меры
Дубли/расхождения → идемпотентность, антидубли в БД, контрольные отчёты.
 Сбои внешних → очереди/ретраи/алерты; развязка потоков.
 Кастом 10.3 → аудит, тестовый стенд, ночные переключения, план отката.
 Человеческий фактор (ДС) → обязательные шаги, подсветка аномалий, обучение.

15. Критерии приёмки (UAT/DoD)
НСИ p95 ≤ 60 c; документы p95 ≤ 120 c; отчёт сверки: расхождения < 0,5%, без критичных.
 Повтор с тем же Idempotency‑Key — без дубля (возвращается исходный ответ).
 ПКО/РКО/подотчёт — корректные суммы/НДС; отчёт «Должен/Сдал» ≤ 0,3%.
 Cutover сайта на УТ 11 — 48 ч без красных алертов.
 Инструкции выданы; on‑call настроен.

16. Приложения (скелет)
A) Таблица маппинга полей (НСИ/документы/статусы).
 B) Матрица конвертации статусов заказа 10.3↔11.
 C) UAT чек‑листы и Smoke‑сценарии.
 D) Реестр рисков (владелец/порог/действия).

Глоссарий (без тех. жаргона)
SoT (Source of Truth) — «где правда» по объекту данных.
 КД3 — типовой механизм 1С для массового переноса данных.
 REST/JSON — формат и стиль программного обмена.
 Middleware (MW) — «почтальон» между системами; гарантирует доставку и отсутствие дублей.
 Idempotency‑Key / X‑Correlation‑Id — метки для защиты от дублей и сквозной трассировки.
 Cutover — момент переключения на новую «точку правды».
 UAT — проверка решения пользователями.
 RPO/RTO — сколько данных можно потерять / за сколько восстановиться.
 SLA/SLO — целевые уровни сервиса / конкретные нормы скорости/надёжности.

## Changelog
- 30.09.2025 — Расширён перечень доменов (`system`, `returns`, `b24-calls`, `walking-warehouse`) и эндпоинтов согласно `openapi.yaml` v1.0.0; обновлены общие требования и ссылки на выгрузки Bitrix24.
- 28.09.2025 — Синхронизирована привязка к ER Freeze v0.6.4 (факт) в шапке и ссылках. [#PR TBD](https://github.com/mastermobile/mastermobile/pull/TBD)
- 25.09.2025 — Перешли на API-Contracts v1.1.0: зафиксированы домены `returns` и `walking-warehouse`, расширены требования к API.
- 20.09.2025 — Обновлено выравнивание с API-Contracts v1.0.0: актуализированы обязательные заголовки, перечень эндпоинтов (только returns) и политика версионирования.
