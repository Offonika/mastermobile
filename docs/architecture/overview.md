# Архитектурный обзор (C4)

Версия: 0.3 • Статус: согласованный черновик

## Контекст уровня системы
- **MasterMobile Middleware** — единый слой интеграции между 1С:Управление торговлей и Bitrix24. Он принимает события, нормализует данные, хранит операционное зеркало master data и управляет идемпотентной синхронизацией документов и статусов.
- **1С:Управление торговлей** публикует НСИ и бухгалтерские документы, принимает подтверждения обработки и обновления статусов, но не является единственным источником истины для мобильного потока: финальные состояния задач и возвратов лидируются middleware.
- **Bitrix24** выступает фронтом для курьеров: отображает задачи, мгновенные заказы и возвраты, отправляет события обратно в middleware.
- **Операторы Back-office** используют отчёты и события middleware для контроля SLA и ручного разрешения коллизий.

## Контейнерный уровень
| Контейнер | Технологии / хостинг | Ответственность | Особые требования |
| --- | --- | --- | --- |
| **Middleware (FastAPI)** | Python 3.11, FastAPI, Uvicorn, Docker/K8s | REST API `/api/v1`, вебхуки интеграций, журналирование IntegrationLog, публикация событий | JWT Bearer с ролями `1c`, `courier`, `admin` (см. «00‑Core — Синхронизация документации», §2.6); заголовки `X-Request-Id`, `Idempotency-Key`, трассировка OpenTelemetry |
| **PostgreSQL 16** | Managed PaaS / VM | Персистентное хранилище бизнес-объектов, идемпотентных ключей и аудита | Репликация, шифрование «на покое», миграции Alembic, хранение логов ≥ 90 дней |
| **Redis 7** | Managed cache/queue | Очереди исходящих событий, отложенные ретраи, кэш конфигураций | Экспоненциальный backoff, DLQ, TTL ключей 24 ч |
| **Обработчики интеграций** | Celery/Async workers | Коннекторы к 1С и Bitrix24, нормализация payload, валидация схем | Повторяемость задач, ограничение по квотам API, Circuit Breaker |
| **Observability Stack** | Prometheus, Loki, Tempo/Grafana | Метрики, логи, трассировки, алерты | Корреляция по `X-Request-Id`, инцидентные дешборды, оповещения в Slack/Telegram |

## Компоненты middleware
- **API Layer** — FastAPI-приложение, реализующее контракт `openapi.yaml`, проверку ролей и идемпотентность.
- **Domain Services** — слой бизнес-правил: проверка SoT, расчёт статусов, валидация маппингов с 1С/Bitrix24.
- **Integration Connectors** — адаптеры к REST/CommerceML 1С и Bitrix24, обеспечивающие трансформацию схем и подтверждение доставки.
- **Event Bus** — публикация CloudEvents в очередь, управление ретраями и outbox-паттерн.
- **Observability & Audit** — единая обвязка логов, метрик, трассировок, а также IntegrationLog с деталями запросов и ответов.

## Потоки данных
1. **НСИ и справочники**: 1С публикует обновления, middleware нормализует их и распространяет в собственные модели и Bitrix24; расхождения сверяются по курсорам и reconcile-процессам.
2. **Операции доставки**: middleware формирует задачи доставки, обновляет их в Bitrix24 и передаёт подтверждения исполнения обратно в 1С.
3. **Мгновенные заказы и возвраты**: курьеры инициируют запросы из Bitrix24, middleware фиксирует события, проверяет идемпотентность и синхронизирует итоговые статусы с ERP 1С.
4. **Финансовые операции**: данные ПКО/РКО/подотчёта проходят через middleware, проводятся в 1С, контролируются SLA и публикуются уведомления об отклонениях.
5. **Наблюдаемость**: каждый запрос сопровождается `X-Request-Id`, метрики собираются из API и воркеров, события аномалий отправляются в Slack/Telegram.

## Контракты и артефакты
- **API** — спецификация `openapi.yaml` (версия v1), заголовки `Idempotency-Key`, `X-Request-Id`, bearerAuth с ролями.
- **Маппинги** — документы `docs/integrations/*.md` описывают соответствие сущностей 1С и Bitrix24 внутренним моделям.
- **События** — формат CloudEvents и гарантии доставки в `docs/integrations/events.md`.
- **НФТ** — требования к доступности, производительности и масштабированию в `docs/nfr.md`.
- **Безопасность и наблюдаемость** — см. `docs/security/threat-model.md` и `docs/observability.md`.

## Эксплуатационные аспекты
- Развёртывание через Docker Compose/K8s, конфигурация через переменные окружения и секреты.
- Катастрофоустойчивость: RTO ≤ 15 мин, RPO ≤ 5 мин, резервные копии БД и восстановление очередей.
- Обновления выполняются по blue/green или canary-сценариям с проверкой совместимости API и схем данных.
- Платформа поддерживает UAT-гейты: проверка контрактов, интеграционных тестов и мониторингов перед релизом.
