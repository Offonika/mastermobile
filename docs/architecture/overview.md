# Архитектурный обзор (C4)

Версия: 0.2 • Статус: рабочий черновик

## Контекст

- Middleware (FastAPI) выступает посредником между действующей 1С:УТ 10.3 (источник истины на старте), целевой 1С:УТ 11 и сервисами доставок, сохраняя непрерывность обмена данными и исключая простои в процессе миграции.【F:docs/SRS — Core Sync 1С: УТ 10.md†L1-L39】【F:docs/00‑Core — Синхронизация документации.md†L187-L209】
- Бизнес-роль Product Owner и интеграторы 1С определяют SoT и cutover-план; команда Middleware отвечает за API, очереди, идемпотентность и журнал интеграций, а Bitrix24 остаётся фронтом для курьеров.【F:docs/SRS — Core Sync 1С: УТ 10.md†L15-L28】【F:docs/ONE-PAGER — Переход 1С: УТ 10.md†L14-L24】【F:docs/00‑Core — Синхронизация документации.md†L247-L254】
- Основные внешние участники: 1С:УТ 10.3/11, сайт на 1С-Битрикс (стандартный обмен), Bitrix24 (виджет курьера), а также Back-office 1С, использующий единые статусы и метрики для контроля операций.【F:docs/SRS — Core Sync 1С: УТ 10.md†L35-L39】【F:docs/Концепция проекта.md†L3-L52】【F:docs/ONE-PAGER — Переход 1С: УТ 10.md†L153-L185】

## Контейнеры

| Контейнер | Технологии / хостинг | Ответственность | Особенности безопасности и наблюдаемости |
| --- | --- | --- | --- |
| Middleware (MW) | FastAPI (Python 3.11+) | REST API, вебхуки, интеграционные очереди, журнал IntegrationLog | JWT Bearer с ролями 1c/courier/admin, обязательные Idempotency-Key и X-Correlation-Id, поддержка traceparent/tracestate【F:docs/adr/0001-tech-stack.md†L1-L4】【F:docs/API‑Contracts.md†L35-L48】 |
| PostgreSQL 16 | Managed/VM | Персистентное хранилище (orders, tasks, integration_log, idempotency_key, SoT-словарь) | Хранение идемпотентных ключей (TTL 72 ч), маскирование ПДн в логах, удержание журналов 90 дней.【F:docs/API‑Contracts.md†L41-L47】【F:docs/00‑Core — Синхронизация документации.md†L87-L104】【F:docs/00‑Core — Синхронизация документации.md†L247-L260】 |
| Redis 7 | Managed cache/queue | Очереди ретраев, фоновые джобы, DLQ | Ретраи 1м→5м→15м→1ч→3ч→12ч, лимит ≤24 ч, поддержка DLQ и ручного реплея.【F:docs/Software Requirements Specification SRS.md†L241-L253】【F:docs/API‑Contracts.md†L12-L13】【F:docs/API‑Contracts.md†L85-L88】 |
| 1С:УТ 10.3 | On-prem 1С | Текущий SoT для НСИ и документов; инициатор событий в MW | Авторизация по сервисному JWT (роль `1c`), доставляет дельты НСИ/документов через REST и КД3.【F:docs/SRS — Core Sync 1С: УТ 10.md†L48-L83】【F:docs/API‑Contracts.md†L92-L136】 |
| 1С:УТ 11 | On-prem 1С | Целевой SoT (волнами), зеркальное хранение документов | Получает подтверждения и события из MW, переводится в мастер по объектам согласно SoT-матрице.【F:docs/SRS — Core Sync 1С: УТ 10.md†L74-L107】 |
| Bitrix24 (виджет курьера) | SaaS | UI для курьеров, управление задачами и мгновенными заказами | Использует API MW с ролями `courier`, подпись вебхуков, rate limit 600 rpm / 30 rps, retry/backoff для исходящих событий.【F:docs/API‑Contracts.md†L138-L160】【F:docs/API‑Contracts.md†L49-L51】【F:docs/API‑Contracts.md†L82-L88】 |
| Сайт 1С-Битрикс | SaaS/On-prem | Канал продаж; продолжает стандартный обмен с 1С | Источник данных переключается с УТ 10.3 на 11 после cutover, обмен через CommerceML/REST.【F:docs/Концепция проекта.md†L31-L68】【F:docs/SRS — Core Sync 1С: УТ 10.md†L35-L38】 |

## Коммуникации

- 1С:УТ 10.3 инициирует REST-запросы в MW (JWT роль `1c`) для задач доставки, обновления рюкзака курьера и денежных операций; запросы подписываются Idempotency-Key, X-Correlation-Id и X-Api-Version 1.1.3, ответы содержат API-Version и ведут IntegrationLog.【F:docs/API‑Contracts.md†L92-L137】【F:docs/00‑Core — Синхронизация документации.md†L24-L38】【F:docs/00‑Core — Синхронизация документации.md†L247-L254】
- MW вызывает вебхуки и обратные подтверждения в 1С/Bitrix24 по тем же корреляционным идентификаторам, используя подпись X-Webhook-Signature и график ретраев до DLQ при ошибках на стороне потребителей.【F:docs/SRS — Core Sync 1С: УТ 10.md†L197-L205】【F:docs/API‑Contracts.md†L82-L88】
- Курьерский виджет в Bitrix24 обращается к API MW по JWT с ролью `courier`, передавая статусы, мгновенные заказы и подтверждения доставки; обязательны Idempotency-Key, X-Correlation-Id и соблюдение rate limit/429 semantics.【F:docs/API‑Contracts.md†L138-L160】【F:docs/API‑Contracts.md†L41-L55】
- MW взаимодействует с PostgreSQL для записи идемпотентных ключей, задач, IntegrationLog и метрик; выдерживает SLA p95 ≤ 400 мс на чтение и ≥99.5% доступности для критичных операций.【F:docs/00‑Core — Синхронизация документации.md†L80-L111】【F:docs/00‑Core — Синхронизация документации.md†L247-L254】
- Очереди MW работают поверх Redis: исходящие события и повторные попытки сериализуются в очередь с экспоненциальным backoff; DLQ сигнализирует об истечении лимита 24 часа для ручного вмешательства.【F:docs/Software Requirements Specification SRS.md†L241-L253】【F:docs/API‑Contracts.md†L12-L13】【F:docs/API‑Contracts.md†L85-L88】
- Наблюдаемость обеспечивается едиными заголовками X-Correlation-Id, поддержкой W3C Trace Context (traceparent, tracestate) и хранением IntegrationLog 90 дней для разбора инцидентов.【F:docs/API‑Contracts.md†L41-L48】【F:docs/00‑Core — Синхронизация документации.md†L247-L260】

## Потоки данных

1. **НСИ (SoT волнами)**: 1С:УТ 10.3 остаётся источником каталога товаров, контрагентов, складов и цен, публикуя bulk-загрузки через КД3 и дельты через REST в MW; MW записывает изменения и реплицирует их в 1С:УТ 11, где по волнам объекты становятся мастером.【F:docs/SRS — Core Sync 1С: УТ 10.md†L48-L67】【F:docs/00‑Core — Синхронизация документации.md†L187-L205】
2. **Заказы на доставку**: документ создаётся в 1С:УТ 10.3, MW регистрирует задачу в Bitrix24 через REST, контролирует статусы и гарантирует отсутствие дублей за счёт Idempotency-Key и журналирования; подтверждения и статусы возвращаются обратно в обе 1С через MW.【F:docs/SRS — Core Sync 1С: УТ 10.md†L73-L97】【F:docs/API‑Contracts.md†L92-L160】【F:docs/00‑Core — Синхронизация документации.md†L26-L91】
3. **Мгновенные продажи и возвраты**: курьер инициирует мгновенный заказ или изменение статуса задачи в Bitrix24, MW валидирует данные, фиксирует idempotency_key, и публикует события в 1С; возвраты и инциденты проводятcя в 1С с мастер-обработкой по событию MW.【F:docs/API‑Contracts.md†L138-L160】【F:docs/SRS — Core Sync 1С: УТ 10.md†L83-L107】【F:docs/00‑Core — Синхронизация документации.md†L93-L104】
4. **Денежные операции и отчётность**: MW принимает сведения о наличных (ПКО/РКО/подотчёт) из 1С и Bitrix24, сохраняет их в БД с корреляцией и ретраями через Redis; сверки и отчётность выполняются в MW в режиме read-only с источником истины в 1С.【F:docs/SRS — Core Sync 1С: УТ 10.md†L98-L108】【F:docs/API‑Contracts.md†L129-L134】【F:docs/00‑Core — Синхронизация документации.md†L187-L209】
5. **Мониторинг и UAT**: все операции логируются с X-Correlation-Id и доступны для трассировки, что позволяет выполнять UAT-гейты, метрики p95 и алерты по SLA (latency, error-rate, очередь task_events).【F:docs/00‑Core — Синхронизация документации.md†L247-L254】【F:docs/00‑Core — Синхронизация документации.md†L251-L254】
