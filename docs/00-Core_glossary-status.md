Название · Версия: v1.0 · Дата: 2025-09-27 · Владелец: Архитектура · Статус: Draft
Связанные документы: [00‑Core — Синхронизация документации](00%E2%80%91Core%20%E2%80%94%20%D0%A1%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8.md), [API‑Contracts v1.1.0](API%E2%80%91Contracts.md)

## 1. Термины и сокращения

| Термин | Определение |
| --- | --- |
| **SoT (Source of Truth)** | Система, в которой хранятся каноничные данные. Отсюда выполняется репликация в остальные сервисы; зафиксировано в [SoT-Matrix](00%E2%80%91Core%20%E2%80%94%20%D0%A1%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8.md#5-sot-matrix-v1-source-of-truth). |
| **Delta / Зеркало** | Интеграционный режим Core Sync, при котором фиксируются только изменения (delta) и синхронизируются в MW; «Зеркало» — полный снимок данных для выравнивания с SoT. |
| **MW (Middleware)** | Центральное приложение MasterMobile, принимающее данные от 1С, Bitrix24 и мобильных клиентов; содержит бизнес-правила, очереди и статусы. |
| **Core Sync** | Поток интеграции 1С с MW; обеспечивает обмен заказами, возвратами, НСИ и справочниками статусов независимо от редакции конфигурации. |
| **Walking Warehouse (WW)** | Мобильный поток «Ходячий рюкзак», который использует статусы доставки и моментальных продаж, синхронизированных с MW. |
| **Status-Dictionary** | Справочник `status_dict`, в котором хранятся коды статусов, допустимые переходы, видимость для ролей и вебхуки. |
| **ER Freeze** | Зафиксированная версия схемы БД MW; любые изменения требуют RFC и миграции. |
| **Idempotency-Key** | Обязательный заголовок для модифицирующих запросов API, гарантирующий повторяемость операций. |

## 2. Status-Dictionary v1

Единый словарь статусов и допустимых переходов для проектов Core Sync и Walking Warehouse. Используется API, фронтом и интеграциями; хранится в справочнике `status_dict`. Расширения выполняются через RFC и синхронизируются с [API‑Contracts](API%E2%80%91Contracts.md#510-%D0%BC%D0%B0%D1%82%D1%80%D0%B8%D1%86%D0%B0-%D0%BF%D0%B5%D1%80%D0%B5%D1%85%D0%BE%D0%B4%D0%BE%D0%B2-%D1%81%D1%82%D0%B0%D1%82%D1%83%D1%81%D0%BE%D0%B2-walking-warehouse).

### 2.1. Доставка (task / delivery_order)

Основная последовательность: `NEW → PICKING → READY → PICKED_UP → ON_ROUTE → DELIVERED → CASH_RETURNED → DONE`.

| Статус | Видимость | Допустимые предыдущие | Допустимые следующие | Примечания |
| --- | --- | --- | --- | --- |
| **NEW** | manager | — | PICKING | Создан заказ, ожидает комплектации. |
| **PICKING** | manager | NEW | READY | Склад комплектует заказ. |
| **READY** | manager | PICKING | PICKED_UP · REFUSED | Упаковка завершена, заказ готов к выдаче. |
| **PICKED_UP** | courier | READY | ON_ROUTE · FAILED | Курьер забрал заказ; далее доставка или фиксация SLA нарушения. |
| **ON_ROUTE** | courier | PICKED_UP | DELIVERED · FAILED | Курьер в пути. |
| **DELIVERED** | courier | ON_ROUTE | CASH_RETURNED · FAILED | Заказ выдан клиенту, ожидается передача наличных. |
| **CASH_RETURNED** | manager | DELIVERED | DONE | Подтверждена передача наличных в кассу. |
| **DONE** | manager | CASH_RETURNED | — | Финальный статус, заказ закрыт. |
| **FAILED** | manager | ON_ROUTE · DELIVERED | — | Нарушение SLA, требуется ручная обработка. |
| **REFUSED** | manager | READY | — | Отказ клиента/менеджера; заменяет устаревший `CANCELLED`. |

#### Устаревшие статусы

- `CANCELLED` — заменён на `REFUSED`; в `status_dict` помечается `deprecated=true`.
- `NON_CASH_CONFIRMED` — закрывается статусом `DONE`.
- `CLOSED` — слит с `DONE`, исторические записи мигрируют на новый код.

### 2.2. Instant Orders (быстрые продажи курьера)

Цепочка: `DRAFT → PENDING_APPROVAL → APPROVED → (DELIVERED | CANCELLED)`.

Дополнительные статусы: `REJECTED` (отказ менеджера) и `TIMEOUT_ESCALATED` (автоматическая эскалация при превышении SLA).

| WW status | KMP4 code | Описание |
| --- | --- | --- |
| NEW | new | Заказ создан и ожидает назначения. |
| ASSIGNED | assigned_to_courier | Курьер назначен. |
| IN_TRANSIT | courier_on_route | Курьер доставляет заказ. |
| DONE | completed | Доставка завершена. |
| REJECTED | cancelled_by_manager | Отказ менеджера. |
| DECLINED | declined_by_courier | Отказ курьера. |

Изменения словаря требуют обновления маппинга `WW_TO_KMP4_STATUS` и документации в `1c/README.md`.

### 2.3. Возвраты (return / return_line)

Подпроцесс: `pending → accepted | rejected` (`cancelled` — отмена заявки до обработки).

| Статус | Видимость | Допустимые предыдущие | Допустимые следующие | Триггеры |
| --- | --- | --- | --- | --- |
| **pending** | manager · courier | return_ready | accepted · rejected · cancelled | Событие `return_ready` в MW переводит возврат в ожидание обработки. |
| **accepted** | manager | pending | — | Формируется и проводится документ «Возврат товаров от покупателя» в 1С. |
| **rejected** | manager | pending | — | Создаётся подзадача «Вернуть клиенту»; уведомления менеджеру и курьеру. |
| **cancelled** | manager | pending | — | Клиент отменил заявку до обработки. |

#### 2.3.1. Модель данных справочника `status_dict`

Для каждой записи хранятся поля: `code`, `title`, `role_visible` (courier/manager), `allowed_prev`, `allowed_next`, `webhook_out` (канал уведомлений), `ui_chip`. Поля `deprecated` и `metadata` используются для маркировки устаревших статусов и хранения дополнительных атрибутов.

## 3. Правила обновления

1. Любое изменение статуса или маппинга фиксируется в `docs/00‑Core — Синхронизация документации.md` и в changelog соответствующего PRD/SRS.
2. Изменения статусов требуют обновления API-контрактов, ER Freeze и тестов `apps.mw`.
3. Новые статусы должны иметь определённый SoT, регламент интеграции (Delta/Зеркало) и владельца из таблицы RACI.
