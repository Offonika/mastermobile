<!-- filename: docs/adr/0001-tech-stack.md -->

# ADR-0001: Технологический стек

- **Статус:** Accepted
- **Дата:** 2024-02-01
- **Область:** Backend / Integrations

## Контекст
- Middleware соединяет 1С:УТ 10.3, 1С:УТ 11 и Bitrix24. Нужен веб-слой, способный обрабатывать высокое количество интеграционных вызовов, обеспечивать идемпотентность и расширяться под новые потоки.
- Команда уже поддерживает инфраструктуру Python и FastAPI, CI/CD настроен на проверку `openapi.yaml`, Ruff, MyPy, PyTest и docker-compose окружения.
- Документация (ER/DDL, API Contracts, Observability, Threat Model) и шаблоны миграций написаны под стек Python + Postgres + Redis. Замена стека разорвёт связь между документацией и реализацией.

## Решение
### Язык и фреймворки
- Python 3.11+ как основной язык разработки.
- FastAPI + Pydantic в качестве веб-фреймворка и механизма валидации схем.
- Uvicorn с workers от Gunicorn для продового деплоя; uvicorn-standalone для локальной разработки.

### Данные
- PostgreSQL 16 как основное хранилище, SQLAlchemy + Alembic для ORM и миграций.
- Redis 7 как in-memory кеш и брокер очередей (Celery/Arq/RQ).
- Стандартизованные схемы (JSON Schema/OpenAPI) синхронизируются с документацией и тестами.

### Интеграции и события
- HTTP-клиенты на httpx/async, поддерживающие таймауты, ретраи, Idempotency-Key.
- CloudEvents поверх Redis/Kafka (в зависимости от окружения) с гарантией at-least-once.

### Качество и эксплуатация
- Makefile orchestrates lint/typecheck/tests/compose; CI повторяет эти шаги.
- Использование Ruff, Black, MyPy, PyTest, pytest-asyncio для асинхронных тестов.
- Observability через OpenTelemetry SDK с экспортом в Prometheus (метрики), Loki (логи) и Tempo/Jaeger (трейсы).

## Последствия
- Новые сервисы и воркеры могут использовать общие базовые обвязки (логирование, метрики, конфигурация) без дублирования.
- Расширение API требует синхронизации с `openapi.yaml` и запусков CI, что упрощает контроль контрактов.
- Мы зависим от инфраструктуры Python; требования к производительности решаются горизонтальным масштабированием и оптимизацией кода.
- В долгосрочной перспективе может потребоваться отдельный брокер сообщений (Kafka) для высокой нагрузки, но текущее решение покрывает ближайшие волны миграции.

## Альтернативы
- **Node.js / TypeScript** — отказались из-за отсутствия опыта команды и отсутствия готовых шаблонов интеграций.
- **Go** — лучше подходит для высоконагруженных сервисов, но потребовал бы переписывания документации, генераторов и инфраструктуры CI.
- **Monolith в 1С** — не покрывает требования к наблюдаемости, идемпотентности и независимым релизам.

## Follow-up
- Поддерживать шаблон запуска воркеров и reusable компонентов интеграций.
- Зафиксировать паттерны OpenTelemetry и логирования в отдельном пакете `apps/mw/observability` после появления кода.
- Периодически пересматривать стек при изменении SLA или появлении новых потоков, требующих иной инфраструктуры.
