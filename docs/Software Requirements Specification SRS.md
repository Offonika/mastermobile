Software Requirements Specification (SRS)
Проект: Курьерская доставка с «Ходячим складом»
 Версия: v0.3.1 (синхронизировано с 00‑Core v1.3)
 Дата: 18.09.2025
 Владелец: Операции / IT
 Связано: PRD «Ходячий склад» v1.3.2, ONE‑PAGER v1.3, Core Sync (1С 10.3↔11), API‑Contracts v1.1.3
 Ссылки на 00‑Core v1.3: §2 Core‑API‑Style; §3 Status‑Dictionary; §4 ER Freeze v0.6.4; §5 SoT‑Matrix; §8 Metrics & Alerts; §9 Retention; §10 Environments; §11 DR/BCP; §16 Error Registry; §17 OpenAPI; §18 1С↔MW Mapping.

1. Обзор и границы
Цель. Запустить управляемую доставку 1С УТ 10.3 ↔ Middleware ↔ Bitrix24 с «рюкзаком курьера», быстрой продажей «с места», фото‑контролем, фиксацией гео и корректным учётом наличных. Без создания новых типов документов в 1С (возвраты — только стандартный «Возврат товаров от покупателя» через мастер).
 In v1:
1С: кнопки/поля/регламентки, ПКО‑черновик, «Положить в рюкзак», «Сопутствующие».


MW (FastAPI): интеграция 1С↔B24, рюкзак, instant‑orders, логи, идемпотентность, очереди/ретраи.


Bitrix24: задачи (UF‑поля), канбан‑стадии, фото (Диск), ссылка на виджет.


Виджет (web/PWA): «Рюкзак», «Продажа из рюкзака», оффлайн‑черновик (продажа), возвраты — только online.
 Out v1: живой GPS‑трек, авто‑маршруты, ML‑рекомендации, нативное приложение.



2. Глоссарий
Рюкзак — виртуальный склад курьера (остатки, тип цен).


Instant‑order — быстрый заказ, созданный курьером «с места».


Наложка (COD) — сумма к получению при вручении.


ПКО — приходный кассовый ордер (черновик при «Отдан (наличные)»).


Idempotency‑Key — уникальный ключ идемпотентности модифицирующих вызовов.


X‑Correlation‑Id — сквозной идентификатор для трассировки.


return_ready — событие в MW об инициации возврата курьером; в 1С документов пока нет.


return_rejected — статус возврата в MW при отклонении брака (движений в 1С нет; создаётся подзадача «Вернуть товар клиенту»).



3. Персоны и ключевые сценарии
Менеджер (1С): сборка, «Отправить в B24», «Положить в рюкзак», подтверждение instant‑order, мастер возврата по реализации.
 Курьер (B24 + виджет): Забрал/Старт/Отдан/Сдача денег; продажа из рюкзака; приём возврата (online).
 Логист (B24): канбан стадий, переназначение, исключения, мониторинг.

4. Таблица трассировки требований (PRD → SRS → UAT)
PRD ID
Требование
Раздел SRS
DoD/UAT
PRD‑US‑M1
«Готов» создаёт задачу в B24 ≤10с
§6.1, §5.1
UAT‑01
PRD‑US‑C2
Продажа из рюкзака, подтверждение ≤3 мин
§6.4, §5.4
UAT‑07
PRD‑NFR‑API
p95 API ≤400 мс
§7.1
UAT‑NFR‑02
PRD‑FIN‑ПКО
ПКО‑черновик при DELIVERED + наличные
§8
UAT‑FIN‑03
PRD‑PHOTO‑GEO
Фото 3 этапа, гео на Старт/Отдан
§6.5/§6.6
UAT‑05
PRD‑RET‑IDEM
TTL идемпотентности 72 ч
§5.2, §7.2
UAT‑NFR‑03
PRD‑RET‑GEO
Гео хранится ≤30 дн
§7.3, §10
UAT‑SEC‑02


5. Функциональные требования по модулям
5.1 1С УТ 10.3
Поля заказа: Адрес, Телефон (+7XXXXXXXXXX), Цена доставки, Сумма к получению, Способ оплаты доставки, Комментарий курьеру, TaskIdB24, «Статус доставки» (enum — по Status‑Dictionary v1), IdempotencyKey.


Кнопки: «Отправить в B24», «Сопутствующие», «Положить в рюкзак».


Регламентки: синхронизация статусов/фото/сумм из B24/MW (1–3 мин); автосоздание ПКО‑черновика при DELIVERED + наличные; инвентаризация рюкзаков.


5.2 Middleware (FastAPI)
Роль: API‑шлюз 1С↔B24↔Виджет; хранилище рюкзака; instant‑orders; идемпотентность; очереди/ретраи; аудит.


Сущности (ER Freeze v0.6.4): couriers, courier_stock, orders, instant_orders, task_events, integration_log, idempotency_key, status_dict, returns, return_lines, return_reason; денежные поля с currency_code (RUB).


Бизнес‑правила:


Идемпотентность по Idempotency‑Key (TTL 72 ч; UNIQUE (key, endpoint, actor_id)).


Все внешние вызовы — через очереди; ретраи (экспоненциальный backoff до 24 ч).


Фото/ПДн не храним — только ID/ссылки.


Временные зоны — UTC (RFC3339Z); NTP‑синхронизация обязательна.


Для quality='defect' reason обязателен (бизнес‑валидатор/DDL CHECK).


5.3 Bitrix24
UF‑поля задачи: адрес, телефон, delivery_price, cod_amount, фото (pickup/handout/cash — ID файлов Диска), гео‑точки (lat/lon/ts).


Статусы/стадии: статусы из Status‑Dictionary v1 (B24↔MW↔1С — единый маппинг).


UI‑требования: чек‑листы по фото, кнопки «Забрал/Старт/Отдал/Деньги сданы», ссылка «Открыть виджет».


5.4 Виджет (web/PWA) «Рюкзак/Продажа»
Экран «Рюкзак»: список позиций (Фото*, Наименование, SKU, Цена, Остаток), поиск + сканер.


«Продажа»: выбор клиента (телефон/поиск), позиции и qty → отправка instant‑order → ожидание подтверждения → показать «К оплате».


Оффлайн‑черновики: кэш рюкзака и черновиков → авто‑синк при сети.


Возврат: только online; приём формирует событие return_ready в MW.



6. API‑контракты (anchors v1.1.3)
 Общие заголовки (см. 00‑Core §2; API‑Contracts v1.1.3):
 Idempotency-Key: <uuid> (для модифицирующих), X-Correlation-Id: <uuid>, X-Api-Version: 1.1.3, Authorization: Bearer <JWT>.

Запросы к API v1 передают заголовок X-Api-Version: 1.1.3 (актуальная минорная версия контракта). Ответы middleware возвращают заголовок API-Version: 1.1.3.
6.1 POST /api/v1/orders/{id}/ready
Создать задачу в B24, записать task_id_b24.
 Request
{
  "address": "Москва, Тверская, 1",
  "phone": "+79991234567",
  "delivery_price": 300,
  "cod_amount": 1500,
  "comment": "Код домофона 123",
  "courier_b24_id": 42,
  "currency_code": "RUB"
}

Response 201
{ "task_id_b24": 123456 }

Ошибки: validation.*, not_found.order, conflict.duplicate, integration.b24_unavailable.
6.2 POST/GET /api/v1/couriers/{id}/stock
Обновить/получить содержимое рюкзака.
 POST
{ "items": [{ "sku": "IP15PM-GLASS", "qty": 5, "price_type_id": "RUCHEK" }] }

GET поддерживает ETag/If-None-Match.
6.3 PATCH /api/v1/tasks/{id}
Обновить статус доставки (только допустимые переходы из Status‑Dictionary v1).
{ "status": "PICKED_UP", "reason_code": null, "reason_note": null }

Примечание: POST /tasks/{id}/status deprecated (Sunset объявлен в API‑Contracts v1.1.3).
6.4 POST /api/v1/instant-orders
Создать мгновенный заказ от курьера.
{
  "courier_id": 7,
  "client_phone": "+79991234567",
  "lines": [{"sku":"IP15PM-GLASS","qty":1}],
  "task_id_b24": 123456,
  "currency_code": "RUB"
}

Response 201
{ "id": 4321, "draft_order_id_1c": "000123", "total": 990 }

6.5 POST /api/v1/tasks/{id}/photos
Привязать фото (ID файла B24 Диска) к событию.
{ "type": "handout", "b24_file_id": "disk:12345", "checksum": "..." }

6.6 POST /api/v1/tasks/{id}/checkins
Чек‑ин гео.
{ "type": "start", "lat": 55.7558, "lon": 37.6173, "ts": "2025-09-13T12:00:00Z" }

6.7 Возвраты
POST /api/v1/returns — инициировать возврат (return_ready):


{
  "source": "widget",
  "courier_id": 7,
  "order_id_1c": "000123",
  "items": [{"sku":"IP15PM-GLASS","qty":1,"quality":"defect","reason_code":"cracked","photos":["disk:123"],"imei":null,"serial":null}]
}

POST /api/v1/returns/{id}/reject — отклонить «брак не подтвердился»:


{ "reason_code": "no_defect_found", "reason_note": "", "items": [{"line_id": 1, "sku":"IP15PM-GLASS","qty":1}], "actor": {"id_1c":"00077","fio":"Иванов И.И."} }

Ошибки и форматы — см. Error Code Registry и API‑Contracts v1.1.3 (application/problem+json, ETag, пагинация/фильтры).

7. Нефункциональные требования (NFR)
7.1 Производительность и доступность
До 30 курьеров одновременно, до 300 задач/день.


MW: p95 ≤ 400 мс (без внешних вызовов), таймауты к B24 10с.


Доступность MW: 99,5%.


7.2 Надёжность
Очереди (Redis), backoff до 24 ч, повторная отправка событий.


Идемпотентность Idempotency‑Key (TTL 72 ч).


Виджет оффлайн (скан/фото/сумма); возвраты — только online.


7.3 Аудит, логи, трассировка
Логи JSON с X‑Correlation‑Id, маскирование ПДн.


integration_log ≥ 90 дн; task_events ≥ 180 дн; idempotency_key TTL 72 ч.


Аудит: статусы, суммы, остатки рюкзака, фото/гео.


7.4 Безопасность и ПДн
Фото/файлы — только в B24 (в MW/1С — ссылки/ID).


TLS, JWT (роли/скоупы), allowlist IP, ротация секретов (JWKS ≤90 дн).


Права: курьер — только свои задачи/рюкзак; менеджер — свои заказы; админ — всё.


Retention (см. 00‑Core §9): сырые фото (≤15 МБ) ≤90 дн; гео ≤30 дн; idempotency_key 72 ч.

Лимит загрузки фото: ≤15 МБ; превышение → HTTP 413; мобильный клиент сжимает до 1,5–2 МБ до отправки.



8. Финансы и бухгалтерия
При DELIVERED + наличные — ПКО‑черновик:


Оплата товаров (НДС как в номенклатуре).


Услуга «Доставка» (НДС по настройке/0%).


Контроль «Должен/Сдал» (допуск ≤0,3%, при расхождении — комментарий + фото).


Бонусы курьеру за допродажи: фикс/процент; отчёт «Бонусы курьера».



9. Инвентаризация «рюкзака»
Виртуальный склад курьера; перемещения из/в основной склад 1С. Партии/IMEI (если применимо); акты пересортицы.
 Цикличная инвентаризация (еженедельно), отчёт по расхождениям; минимальные остатки для ходовых SKU.

10. Гео и фото — стандарты
Фото: JPEG/HEIC, ≤15 МБ (клиентская компрессия до 1,5–2 МБ), EXIF‑время; типы: pickup|handout|cash|return (минимум эти).


Гео: точность 50–150 м; чек‑ин «Старт/Отдан»; таймаут получения 5с; если нет разрешения — geo_missing=true.



11. Модель данных (reference)
Сущности и поля — см. ER Freeze v0.6.4 (orders, order_lines, instant_orders, instant_order_lines, returns, return_lines, return_reason, couriers, courier_stock, task_events, integration_log, idempotency_key, status_dict).


Домены: телефон +7XXXXXXXXXX; деньги numeric(12,2) + currency_code (RUB).


Индексы наблюдаемости/очередей, дедуп фото по checksum, UQ на correlation_id.



12. Тестирование (UAT)
UAT‑01: «Готов» → задача B24 ≤10с; в 1С видны TaskIdB24 и статус «Готов (B24)».


UAT‑03: Забрал/Старт/Отдал/Деньги сданы — фото видны; гео записано.


UAT‑07: Instant‑order → черновик 1С ≤3 мин; сумма совпадает; оффлайн‑черновик отправился при появлении сети.


UAT‑FIN‑03: ПКО‑черновик (товар/доставка, НДС).


UAT‑NFR‑02: нагрузка 30/300 — p95 API ≤400 мс.


UAT‑SEC‑01: маскирование ПДн, доступы по ролям.


UAT‑RET‑01: гео удаляется ≤30 дн; idempotency_key — TTL 72 ч.


UAT‑RET‑02: при return_rejected создаётся подзадача B24 и уведомление клиенту ≤60 с.



13. Мониторинг и эксплуатация
Дашборды: задержки создания задач, 4xx/5xx, очередь ретраев, KPI (TtD, без возврата, наличка, допродажи).
 Алерты: SLA задачи >2 мин; 5xx >1% за 15 мин; очередь >100; лаг синка >5 мин (см. 00‑Core §8).
 Бэкапы: RPO ≤15 мин, RTO ≤2 ч; антипаник — деградация до «только задачи без фото/гео».

14. Риски и смягчение
Оффлайн/сеть → оффлайн‑черновики, повтор.
 Лимиты B24 → очереди + backoff, алерты.
 Человеческий фактор (наличка/фото) → обязательные шаги, подсветка расхождений, двойная сверка.

15. DoD (критерии приёмки)
Все UAT‑кейсы пройдены; повторные POST с тем же Idempotency‑Key не создают дублей; фото/гео консистентны; ПКО‑черновик корректен; рюкзак списывается/пополняется без расхождений (инвентаризация ≥98%); логи/аудит полные; ПДн — под защитой; совместимость API подтверждена для v1.1.3 (без использования deprecated‑методов).

