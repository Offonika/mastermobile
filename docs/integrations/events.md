# События интеграций

## Формат событий
- Тип сообщения: JSON `application/cloudevents+json` v1.0.
- Обязательные поля:
  - `id` — глобальный идентификатор события (UUID v4).
  - `source` — URI-источник (`urn:mastermobile:integration:<system>`).
  - `type` — тип события (`integration.1c.document.synced`, `integration.b24.lead.updated`).
  - `time` — момент генерации события в формате RFC-3339 с таймзоной UTC.
  - `data` — тело события; структура определяется схемой конкретного события и версионируется через поле `data_version`.
- Дополнительные заголовки транспорта: `X-Trace-Id`, `X-Request-Id`.

## Ключи идемпотентности
- Для модифицирующих событий применяется заголовок `Idempotency-Key`.
- Значение формируется как `sha256(<source>|<type>|<external_id>|<data_version>)`.
- Платформа хранит ключи 48 часов; повторные события с тем же ключом и идентичным телом считаются успешным повтором.
- При расхождении payload возвращается ответ `409 Conflict` с описанием несовпадающих полей в `errors[]`.

## Гарантии доставки
- Транспорт — очереди Kafka с политикой `at-least-once` и ретраями 5 → 30 → 120 секунд.
- На стороне потребителя поддерживаем `offset commit` только после успешной записи в целевую БД.
- Для критичных событий (финансы, статусы заказов) дополнительно используется outbox-паттерн и аудит в `events.delivery_audit`.
- Dead-letter queue активируется после 5 безуспешных ретраев; обработчик DLQ отправляет уведомление в канал `#integrations-alerts`.
