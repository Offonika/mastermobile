# Маппинг интеграции с Bitrix24

> Владельцы: @Offonika (интеграции). Уведомление об обновлении направлено 27.09.2025.

## Область действия
- Поддерживаются REST API Bitrix24 и входящие вебхуки.
- Middleware управляет курьерскими задачами, мгновенными заказами и возвратами, опираясь на существующие модели данных.
- Все операции проходят через `/api/v1` с обязательными `Idempotency-Key` и `X-Request-Id` для трассировки.

## Сущности
| Объект Bitrix24 | Таблицы/модели MW | Статус реализации | Примечания |
| --- | --- | --- | --- |
| Заказы/задачи курьера (`tasks.task`, `task.comment`) | `instant_orders`, `instant_order_lines`, `task_events` | реализовано | Основной заказ живёт в `instant_orders` с привязкой к `task_id_b24`, курьеру, сумме и валюте; строки заказа — в `instant_order_lines`. Хронология статусов и вложений Bitrix24 сохраняется в `task_events` (индексы по `task_id_b24`, `type`).【F:docs/ER‑диаграмма и DDL.md†L17-L113】【F:docs/data/erd.mmd†L1-L41】|
| Логистика заказов (закрытие сделок, синхронизация статусов) | `orders`, `task_events` | реализовано | Таблица `orders` используется для доставки, статусы фиксируются через `task_events`; индексы и опциональный FK связывают события Bitrix24 с заказами MW.【F:docs/ER‑диаграмма и DDL.md†L34-L118】|
| Возвраты/инциденты (виджет, формы Bitrix24) | `returns`, `return_lines`, `integration_log` | реализовано | Основная карточка хранится в `returns`, строки — в `return_lines`; события и запросы журналируются в `integration_log` с ретенцией 90 дней и индексами по статусам для онлайн-процессов.【F:docs/ER‑диаграмма и DDL.md†L17-L162】【F:docs/data/erd.mmd†L1-L32】|
| Идемпотентность и повторные вебхуки | `idempotency_key` | реализовано | Уникальный ключ (`key`, `endpoint`, `actor_id`) предотвращает дублирование запросов Bitrix24, TTL — 72 часа.【F:docs/ER‑диаграмма и DDL.md†L120-L144】|
| Сделки (`crm.deal`) | — | не реализовано | Таблицы `crm.*` отсутствуют в ER-модели; поддержка будет добавлена отдельной миграцией.【F:docs/ER‑диаграмма и DDL.md†L16-L23】|
| Лиды (`crm.lead`) | — | не реализовано | Таблицы `crm.*` отсутствуют; требуется постановка задачи на проектирование схемы CRM.【F:docs/ER‑диаграмма и DDL.md†L16-L23】|
| Чаты/открытые линии | — | не реализовано | В ER-диаграмме нет `support.*`; хранилище чатов предстоит спроектировать отдельно.【F:docs/ER‑диаграмма и DDL.md†L16-L23】|

## Ограничения и квоты
- Bitrix24 ограничивает приложение 2 RPS и 120 RPM. Middleware применяет адаптивный троттлинг и очередь запросов.
- Вебхуки подписываются HMAC. Проверяется `X-Signature`, `X-Request-Timestamp`, `X-Request-Id`, отклонения журналируются в SIEM.
- История задач хранится 90 дней в БД и архивируется в объектное хранилище при превышении срока.

## Потоки
1. **Создание мгновенного заказа (Walking Warehouse)**: пользователь в Bitrix24 ставит задачу или комментарий с тегом `instant_order` → вебхук поступает в MW → `POST /api/v1/ww/orders` создаёт запись в `instant_orders` и `instant_order_lines`, фиксирует событие в `task_events` → статус синхронизируется обратно в Bitrix24 через REST.【F:docs/API‑Contracts.md†L119-L148】【F:docs/ER‑диаграмма и DDL.md†L68-L118】
2. **Возврат/инцидент**: курьер инициирует возврат из Bitrix24 → `POST /api/v1/returns` сохраняет карточку в `returns` и строки в `return_lines`, `task_events` фиксирует событие, `integration_log` хранит обмен с Bitrix24 и 1С → статусы обновляются через `PATCH/POST` операции и CloudEvent-публикации.【F:docs/API‑Contracts.md†L59-L90】【F:docs/ER‑диаграмма и DDL.md†L45-L162】
3. **Отчёты и сверки**: Bitrix24 запрашивает агрегированные данные через `GET /api/v1/ww/report/deliveries` или экспорт `GET /api/v1/ww/export/kmp4` → MW читает данные из `orders` и сопутствующих событий, используя индексы по статусам для выполнения SLA по отклику.【F:docs/API‑Contracts.md†L150-L184】【F:docs/ER‑диаграмма и DDL.md†L68-L118】

## Ошибки и ретраи
- Ошибки 4xx содержат `errors[]` с расхождениями полей. Клиент обязан корректировать данные.
- Ошибки 429/503 на стороне Bitrix24 приводят к экспоненциальным ретраям 10с → 30с → 2м → 10м → DLQ.
- Все события включают `X-Request-Id` для корреляции с логами и трассировками.

## Changelog
- 27.09.2025 — Актуализирован маппинг под ER v0.6.4, подтверждено отсутствие `crm.*`/`support.*`, уведомлены владельцы интеграции (@Offonika).
