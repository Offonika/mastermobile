# Маппинг интеграции с Bitrix24

## Область действия
- Поддерживаются REST API Bitrix24 и входящие вебхуки.
- Middleware управляет задачами курьеров, мгновенными заказами и чатами поддержки.
- Все операции проходят через `/api/v1` с обязательными `Idempotency-Key` и `X-Request-Id` для трассировки.

## Сущности
| Объект Bitrix24 | Таблица/модель MW | Поля | Правила |
| --- | --- | --- | --- |
| Сделки (`crm.deal`) | `crm.deals` | `external_id`, `title`, `pipeline_id`, `stage_code`, `budget_amount`, `currency`, `assigned_user_id`, `custom_attributes` | Этапы приводятся к словарю `deal_stage`. При закрытии сделки создаётся заказ доставки в MW |
| Лиды (`crm.lead`) | `crm.leads` | `external_id`, `status`, `source`, `responsible_user_id`, `company_id` | Конверсия лида создаёт ссылку на сделку. Незаполненные `source` помечаются как `unknown` и требуют ручного разбирательства |
| Задачи (`tasks.task`) | `work.tasks` | `external_id`, `title`, `description`, `deadline_at`, `responsible_id`, `tags[]`, `project_id` | Используются для задач курьера. Тег `instant_order` инициирует создание мгновенного заказа |
| Чаты/открытые линии | `support.chat_threads` | `external_id`, `channel`, `customer_id`, `last_message_at`, `assigned_user_id` | Используется для SLA поддержки и аналитики |

## Ограничения и квоты
- Bitrix24 ограничивает приложение 2 RPS и 120 RPM. Middleware применяет адаптивный троттлинг и очередь запросов.
- Вебхуки подписываются HMAC. Проверяется `X-Signature`, `X-Request-Timestamp`, `X-Request-Id`, отклонения журналируются в SIEM.
- История задач хранится 90 дней в БД и архивируется в объектное хранилище при превышении срока.

## Потоки
1. **Создание мгновенного заказа**: пользователь в Bitrix24 ставит задачу с тегом `instant_order` → вебхук поступает в MW → API `/api/v1/returns` или `/api/v1/orders` создаёт заявку → статус синхронизируется обратно в Bitrix24.
2. **Возврат/инцидент**: курьер меняет статус задачи → MW фиксирует событие, сохраняет `Idempotency-Key`, обновляет запись в 1С и публикует CloudEvent.
3. **Отчёты**: Bitrix24 запросами получает статусы задач и сверки; MW возвращает paginated списки, соблюдая NFR по времени ответа.

## Ошибки и ретраи
- Ошибки 4xx содержат `errors[]` с расхождениями полей. Клиент обязан корректировать данные.
- Ошибки 429/503 на стороне Bitrix24 приводят к экспоненциальным ретраям 10с → 30с → 2м → 10м → DLQ.
- Все события включают `X-Request-Id` для корреляции с логами и трассировками.
