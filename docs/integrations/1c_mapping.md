# Маппинг интеграции с 1С:УТ

## Область действия
- Поддерживаются версии 1С:УТ 10.3 (источник) и 1С:УТ 11 (приёмник).
- Middleware выступает посредником: принимает REST/CommerceML события от 1С:УТ 10.3, нормализует данные и транслирует их в целевую 1С:УТ 11 и внутренние модели.
- Фактические домены, реализованные в ER Freeze v0.6.4: возвраты, мгновенные заказы курьеров, задачи/события и журнал интеграций. НСИ, денежные документы и складские перемещения пока не материализованы в базе MW.

## ER Freeze v0.6.4 — актуальные сущности MW
- `core` — `orders`, `order_lines`, `returns`, `return_lines`, `return_reason`, `task_events`, `integration_log`, `idempotency_key`.
- `ww` (Walking Warehouse) — `couriers`, `courier_stock`, `instant_orders`, `instant_order_lines`, `price_type`, `product` (заготовка под ассортимент курьера).
- Схемы `catalog.*`, `logistics.*`, `sales.*`, `finance.*` отсутствуют. Они запланированы в дорожной карте Core Sync и появятся после утверждения ER v0.7 (см. 00‑Core §4).

## НСИ
| Объект 1С | Таблица MW | Статус | Ключевые поля | Примечания |
| --- | --- | --- | --- | --- |
| Номенклатура | — | Планируется | — | Таблицы `catalog.items`/`catalog.categories` не созданы в ER Freeze v0.6.4; НСИ грузится напрямую в 1С 11 до появления витрины MW. |
| Контрагенты | — | Планируется | — | Модель `core.partners` отсутствует; идентификаторы контрагентов передаются в связанных документах строкой. |
| Склады | — | Планируется | — | Схема `logistics` ещё не заведена; до запуска зеркала складов 1С ↔ MW используется справочник источника истины. |
| Пользователи/операторы | — | Планируется | — | Роли поддерживаются на уровне auth/JWT; таблицы `core.users` и RBAC появятся вместе с API v1.2. |
| Курьеры | `ww.couriers` | Реализовано | `courier_id`, `external_id`, `status`, `phone`, `updated_at` | Служит основой для Walking Warehouse; связана с остатками (`ww.courier_stock`) и мгновенными заказами. |

## Документы и события
| Документ 1С | Таблицы MW | Статус | Ключевые поля | Особенности |
| --- | --- | --- | --- | --- |
| Заказ/реализация доставки | `core.orders`, `core.order_lines` | Реализовано (черновик зеркала) | `order_id`, `task_id_b24`, `status`, `delivery_price`, `cod_amount`, `currency_code`, `created_at`/`updated_at` | Используется для подтверждения готовности заказов и синхронизации статусов с Bitrix24; строки заказа хранят SKU/qty/price/vat_rate. |
| Мгновенная продажа курьера | `ww.instant_orders`, `ww.instant_order_lines` | Реализовано | `instant_order_id`, `courier_id`, `status`, `total_amount`, `currency_code`, `created_at`/`updated_at` | Формируется через API `/api/v1/ww/orders`; уникальный индекс `task_id_b24 + courier_id` защищает от дублей. |
| Возврат от клиента | `core.returns`, `core.return_lines`, `core.return_reason` | Реализовано | `return_id`, `order_id_1c`, `courier_id`, `status`, `created_at`/`updated_at`; строки `line_id`, `sku`, `qty`, `reason_code` | Идемпотентность обеспечивается таблицей `core.idempotency_key`; статусная модель `pending|accepted|rejected|cancelled`. |
| Задачи и события доставки | `core.task_events` | Реализовано | `task_id_b24`, `return_id`, `type`, `status`, `ts`, `actor_id`, `payload_json` | Служит шиной наблюдаемости; частичные индексы по `type=status` и `type=photo`. |
| Денежные документы (ПКО/РКО) | — | Планируется | — | Схема `finance` отсутствует; сверка наличных ведётся в 1С. |
| Поступления/перемещения/инвентаризация | — | Планируется | — | Таблицы `inventory.*` пока не заведены. Требования описаны в SRS и будут реализованы вместе с ER v0.7. |

## Статусы и справочники
- Единый словарь статусов хранится в `core.status_dict` (см. 00‑Core §3). Возвраты опираются на `return_reason`, мгновенные заказы — на матрицу переходов `Status-Dictionary v1`.
- Валюты приведены к ISO‑4217 (`currency_code` в `orders` и `instant_orders`, по умолчанию `RUB`).
- Все даты конвертируются в UTC (`timestamptz`) и сохраняются в формате RFC‑3339.

## Правила обмена
- REST-запросы должны содержать `Idempotency-Key` и `X-Request-Id`; повтор с тем же ключом читает ответ из `core.idempotency_key`.
- Повторные запросы с другим телом → `409 Conflict` и запись об ошибке в `core.integration_log` (`status=error`, `error_code=duplicate_payload`).
- Ошибки `422` возвращаются в формате RFC 7807; запись о валидации также попадает в `core.integration_log` c указанием `resource_ref` (`return_id`/`instant_order_id`).
- Журнал интеграций (`core.integration_log`) и события (`core.task_events`) — главный источник наблюдаемости. Для возвратов применяются индексы `idx_returns_status_created`, `idx_returns_status_uat`, `idx_returns_pending`.
- Дельты формируются в соответствии с SoT-матрицей (см. 00‑Core §5):
  - Возвраты и мгновенные заказы зарождаются в MW (`core.returns`, `ww.instant_orders`) и подтверждаются в 1С.
  - Заказы доставки зеркалируются из 1С в `core.orders`; статусы подтверждаются событиями `task_events`.
  - НСИ и финансовые документы остаются в 1С до появления соответствующих таблиц.
- Курсоры и буферы `sync.*` ещё не внедрены; вместо них используется чтение по `ts`/`updated_at` и фильтры в `integration_log`. При подготовке ER v0.7 планируется перенести описание в отдельный документ миграций.
- Дедупликация выполняется на двух уровнях: `Idempotency-Key` + `(endpoint, actor_id)` и бизнес-ключ (`return_id`/`instant_order_id`). При совпадении payload MW возвращает сохранённый ответ и фиксирует событие в `integration_log` c `status=success`, `retry_count` не увеличивается.
- Ночной контроль: пока нет автоматического `sync.reconcile_*`; ручная проверка делается через выгрузку `returns`/`instant_orders` и сравнение со статусами в 1С.

## Ретраи и очереди
- 1С повторяет запросы 3 раза (1 с → 5 с → 30 с) при сетевых ошибках.
- Middleware ставит документы в очередь повторной обработки (Redis) с шагами 5 мин → 30 мин → 2 ч; после 6 попыток задача попадает в DLQ. Каждая попытка логируется в `core.integration_log` с увеличением `retry_count`.
- Для возвратов и мгновенных заказов дополнительно пишется событие `task_events` типа `status` с указанием `actor_id=system`.

### Core subset и внешняя обработка КМП4
- **Ключевые объекты выгрузки**: `1c/config_dump_txt/` содержит модули документов `Документ.ВозвратТоваровОтПокупателя.*`, `Документ.ПеремещениеТоваров.*`, формы и регистры накопления (`ТоварыНаСкладах`, `ТоварыВРезервеНаСкладах`, `ТоварыОрганизаций`). Для уже реализованных сущностей MW использует `core.returns`/`ww.instant_orders`.
- **Внешняя обработка**: исходники обработки КМП4 лежат в `1c/external/kmp4_delivery_report/src/` (пакетируется вместе с XML-артефактом) и включают `Ext/ObjectModule.bsl`, справку (`Ext/Help.xml`), формы `КонсольМенеджераПоПродажам`, `ФормаЗагрузкиЗаявок`, `ПечатьИРассылкаПрайсЛистов`, а также печатные макеты `Templates/ПрайсЛист*.xml`.
- **Правила использования**:
  - выгрузку и обработку держим в режиме read-only и обновляем отдельным PR с пометкой diff от поставщика 1С;
  - при анализе маппинга ссылаться на конкретный объект (`Документ`, `Форма`, `Регистр`), чтобы трассировать изменения в SRS и API;
  - при разработке сценариев КМП4 в middleware проверять покрытие интеграций (hook `ПриЗаписи`, обработка очередей, печатные формы).
- **Связанные доработки**: детализация требований попадёт в [SRS — КМП4 (в подготовке)](../SRS%20—%20КМП4.md); текущая выгрузка служит источником истины до публикации полноценного SRS.
