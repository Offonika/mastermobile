# Маппинг интеграции с 1С

## НСИ
- **Контрагенты** → `core.partners`
  - Поля: `inn`, `kpp`, `full_name`, `status` (активен/заблокирован).
  - Сопоставление статусов: `Действует` → `active`, `Не обслуживается` → `inactive`.
- **Номенклатура** → `catalog.items`
  - Поля: `sku`, `uom_code`, `vat_rate`, `brand`.
  - Атрибут «Серия» маппится в `catalog.items.batch_id` и используется при учёте партий.
- **Склады** → `logistics.warehouses`
  - Поля: `code`, `name`, `address`, `responsible_user_id`.
  - При отсутствии координат запускается процесс геокодирования и заполнения `geo_point`.

## Документы
- **Реализация товаров и услуг** → `sales.shipments`
  - Обязательные поля: `document_number`, `document_date`, `customer_id`, `total_amount`.
  - Позиции документа маппятся в `sales.shipment_items` с детализацией по НДС.
- **Поступление товаров** → `inventory.incoming`
  - Обязательные поля: `supplier_id`, `contract_id`, `planned_receipt_at`.
  - Процесс: после загрузки создаётся задача на приёмку в walking warehouse.
- **Перемещение товаров** → `inventory.transfers`
  - Поля: `source_warehouse_id`, `target_warehouse_id`, `transfer_reason`.
  - При межфилиальном перемещении формируется доп. уведомление в Telegram-бот.

## Правила
- Все документы передаются пакетами не более 500 записей, сортировка по `document_date` ASC.
- Используется идемпотентность по `external_id`; повторы с отличным телом фиксируются в журнале расхождений.
- Валюта сумм конвертируется в `RUB` по курсу ЦБ на дату документа, курс хранится в `finance.fx_rates`.
- При ошибках валидации документ отклоняется с кодом `422` и помещается в очередь повторной отправки каждые 15 минут.
