# Маппинг интеграции с 1С:УТ

## Область действия
- Поддерживаются актуальные релизы 1С:Управление торговлей и Middleware.
- Middleware выступает посредником: принимает REST/CommerceML события от 1С, нормализует данные и публикует во внутренние модели.
- Основные домены: НСИ, документы движения товаров, денежные операции и статусы задач доставки.

## НСИ
| Объект 1С | Таблица MW | Ключевые поля | Примечания |
| --- | --- | --- | --- |
| Номенклатура | `catalog.items` | `external_id`, `sku`, `barcode`, `vat_rate`, `uom_code`, `is_batch_tracked` | Поддерживаются партии и серийные номера; ссылка на категорию из `catalog.categories` |
| Контрагенты | `core.partners` | `external_id`, `inn`, `kpp`, `full_name`, `status` | Статусы маппятся: `Действует` → `active`, `Не обслуживается` → `inactive`, `Черный список` → `blocked` |
| Склады | `logistics.warehouses` | `external_id`, `name`, `type`, `address`, `geo_point`, `responsible_user_id` | При отсутствии координат запускается сервис геокодирования; поле `type` нормализуется (main, transit, courier) |
| Пользователи | `core.users` | `external_id`, `full_name`, `email`, `role` | Используется для привязки задач и ответственности |

## Документы
| Документ 1С | Модель MW | Поля | Особенности |
| --- | --- | --- | --- |
| Реализация товаров и услуг | `sales.shipments` | `document_number`, `document_date`, `customer_id`, `total_amount`, `currency_code`, `lines[]` | Каждая строка содержит `sku`, `qty`, `price`, `vat_rate`; суммы пересчитываются в RUB по курсу ЦБ |
| Поступление товаров | `inventory.incoming` | `supplier_id`, `contract_id`, `planned_receipt_at`, `lines[]` | После приёма создаётся задача в walking warehouse, статус `pending_quality_check` |
| Перемещение товаров | `inventory.transfers` | `source_warehouse_id`, `target_warehouse_id`, `reason_code`, `lines[]` | Поддерживаются межфилиальные перемещения; дополнительные уведомления для `reason_code = interbranch` |
| Возвраты от клиентов | `returns.requests` | `source_system`, `order_id`, `items[]`, `status`, `compensation_amount` | Синхронизируется с API `/api/v1/returns`; Idempotency-Key формируется как SHA256 от `document_number` |
| Денежные документы (ПКО/РКО) | `finance.cash_documents` | `document_number`, `document_date`, `amount`, `cashier_id`, `operation_type` | Используется для сверки наличных и задач курьеров |

## Статусы и справочники
- Единый словарь статусов хранится в `core.statuses`. Сопоставление выполняется при загрузке, непонятные статусы отправляются в очередь расхождений.
- Валюты приводятся к ISO-4217. В случае неизвестного кода документ блокируется и требует ручного вмешательства.
- Все даты конвертируются в UTC и хранятся в RFC-3339.

## Правила обмена
- Документы передаются пакетами ≤ 500 строк, сортировка по `document_date` ASC.
- Для REST-запросов 1С обязательно передаёт `Idempotency-Key` и `X-Request-Id`; `X-Api-Version` во v1.0.0 не используется.
- Повторные запросы с другим телом → `409 Conflict` и запись в `integration_conflicts`.
- Ошибки `422` включают массив `errors[]` с указанием поля и причины; повторная отправка возможна после исправления.
  - каталоги и регистры сведений пишут изменения в `РегистрСведений.MW_ОчередьИзменений` по полю `ДатаИзменения`, что обеспечивает чтение «с последнего курсора»;
  - документы вызывают обработчик при `ПриЗаписи` и `ПриПроведении`, добавляя в очередь ссылку, GUID и контрольную сумму актуального состояния;
  - регистры остатков и взаиморасчётов формируют дельты по изменению `Период`/`Активность`, чтобы пересчитать остатки и задолженности.
- Middleware сохраняет каждую дельту в буфере `sync.delta_feed` с меткой `source_change_ts`; курсоры (`sync.delta_cursor`) поддерживаются по каждому объекту (НСИ, документы, деньги), что позволяет безопасно повторять выгрузку.
- Дедупликация выполняется на трёх уровнях: `Idempotency-Key` + endpoint/actor (TTL 72 ч), составной бизнес-ключ (`номер + дата + организация + склад`) и `payload_hash` (SHA-256). Если хэш уже видели, MW возвращает ранее сохранённый ответ без повторной записи и логирует совпадение в `integration_log`.
- Ночной пакет `sync.reconcile_masterdata` прогоняет контрольные выборки из SoT и сверяет их с зеркалом MW; `sync.reconcile_documents` проверяет, что за последние 24 часа нет пропусков по курсору и при необходимости запрашивает `/api/v1/sync/replay`.

## Ретраи и очереди
- 1С повторяет запросы 3 раза (1с, 5с, 30с) при сетевых ошибках.
- Middleware ставит документы в очередь повторной обработки (Redis) с шагами 5 мин → 30 мин → 2 ч; после 6 попыток задача попадает в DLQ.
- Все события фиксируются в `integration_log` с привязкой к `X-Request-Id` и `Idempotency-Key`.

### Core subset и внешняя обработка КМП4
- **Ключевые объекты выгрузки**: `1c/config_dump_txt/` содержит модули документов `Документ.ВозвратТоваровОтПокупателя.*`, `Документ.ПеремещениеТоваров.*`, набор форм выбора/списка и набор регистров накопления (`ТоварыНаСкладах`, `ТоварыВРезервеНаСкладах`, `ТоварыОрганизаций` и др.), которые отражают текущее поведение обмена между поддерживаемой конфигурацией 1С и MW.
- **Внешняя обработка**: исходники обработки КМП4 лежат в `1c/external/kmp4_delivery_report/src/` (пакетируется вместе с XML-артефактом в корне каталога) и включают `Ext/ObjectModule.bsl`, справку (`Ext/Help.xml`), формы `КонсольМенеджераПоПродажам`, `ФормаЗагрузкиЗаявок`, `ПечатьИРассылкаПрайсЛистов`, а также печатные макеты `Templates/ПрайсЛист*.xml`.
- **Правила использования**:
  - выгрузку и обработку держим в режиме read-only и обновляем через отдельный PR с пометкой diff от поставщика 1С;
  - при анализе маппинга ссылаться на конкретный объект (`Документ`, `Форма`, `Регистр`), чтобы трассировать изменения в SRS и API;
  - при разработке сценариев КМП4 в middleware проверять, что каждая точка интеграции покрыта в выгрузке (hook `ПриЗаписи`, обработка очередей, печатные формы).
- **Связанные доработки**: детализация требований попадёт в [SRS — КМП4 (в подготовке)](../SRS%20—%20КМП4.md); текущая выгрузка служит источником истины до публикации полноценного SRS.
