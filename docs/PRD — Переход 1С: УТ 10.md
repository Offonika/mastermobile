PRD — Переход 1С: УТ 10.3 → УТ 11 (Core Sync, без простоя)
Версия: v1.1.2 (синхронизировано с 00‑Core v1.3.1)
 Дата: 18.09.2025
 Владелец: Операции / IT
 Ссылки на 00‑Core v1.3.1: §2 Core‑API‑Style; §3 Status‑Dictionary; §4 ER Freeze v0.6.4; §5 SoT‑Matrix; §8 Metrics & Alerts; §9 Retention; §10 Environments & Flags; §11 DR/BCP; §16 Error Registry; §17 OpenAPI v1.1.3; §18 1С↔MW Mapping.

1) Резюме
Запускаем УТ 11 параллельно с УТ 10.3 и настраиваем надёжный обмен. На старте SoT = УТ 10.3, затем волнами переводим ввод документов в УТ 11 без простоя. Интернет‑магазин (1С‑Битрикс) остаётся на стандартном обмене; после стабилизации переключим базу‑источник на УТ 11. Контракты и статусы — по единым словарям/стилю из 00‑Core.

2) Цели и KPI v1 (2–4 недели)
Цели: двусторонний обмен НСИ/доками 10.3↔11 с SoT = 10.3; волновой перевод мастера в 11; стабильность обмена сайта.
 KPI: сходимость НСИ ≥ 99,5%; дельты p95 ≤ 60 c; документы p95 ≤ 120 c; 0 дублей на 1000 POST; 5xx < 0,1%/нед, 4xx < 1%/нед; rate‑limit/429 < 0,5%.

3) Scope, допущения и ограничения
In (v1): КД3 (bulk НСИ), дельты REST/JSON, «зеркало» ключевых документов, единый словарь статусов (Status‑Dictionary v1), ПКО/РКО/подотчёт, журнал/идемпотентность/очереди/мониторинг, UAT/обучение.
 Out (v1): маркировка/54‑ФЗ/ЭДО, серийники/IMEI/партии/сроки, маршрутизация/GPS/ML, доработки сайта.
 Допущения: платформа 1С 8.3.x; сайт — CommerceML/REST без кастомизаций; доступна инфраструктура под MW/БД/резерв.

4) Управление: решения и изменения
Decision log: Owner (Операции/IT) — решения по SoT и cutover; Approver (Руководство); SLA решения — 2 раб. дня.
 Change control: изменения объёма/сроков — через CR (описание, влияние, KPI).
 Go/No‑Go (cutover) — ворота (см. 00‑Core §6.2): UAT pass‑rate ≥ 98% за 7 дней; дельты p95 ≤ 120 c; акт сверки «0 критичных»; мониторинг «зелёный» 48 ч на стенде; готов rollback и on‑call.

5) Окружения и выпуск (см. 00‑Core §10)
DEV → TEST → UAT → PROD, анонимизация тест‑данных.
 Миграция: snapshot КД3 → дельты → короткое freeze → cutover.
 Feature‑flags: пообъектный перевод мастера (включаем/откатываем атомарно).

6) Источник истины (SoT) и объекты обмена (см. 00‑Core §5)
Объект
SoT старт
SoT целевой
Канал
SLA дельт
Номенклатура
УТ 10.3
УТ 11 (волна 2)
КД3 + API
≤ 60 c
Контрагенты
УТ 10.3
УТ 11 (2–3)
КД3 + API
≤ 60 c
Склады/ед. изм.
УТ 10.3
УТ 11
КД3
регл.
Типы цен/цены
УТ 10.3
УТ 11 (волна 3)
КД3 + API
регл. + дельты
Ставки НДС
УТ 10.3
УТ 11 (после выверки)
API
по событию
Заказ клиента
10.3 → «зеркало» в 11
Мастер УТ 11 (3+)
API
≤ 120 c
Реализация/Поступление
10.3 → «зеркало» в 11
Мастер УТ 11 (после пилота)
API
≤ 120 c
Перемещение/Списание/Оприходование
УТ 10.3
УТ 11 (3+)
API
≤ 120 c
Инвентаризация
УТ 10.3
УТ 11 (после «сухого»)
API
по акту
Возвраты (покуп./пост.)
УТ 10.3
УТ 11 (3+)
API
≤ 120 c
ПКО/РКО/подотчёт
УТ 10.3
УТ 11 (после стаб.)
API
по событию
Банк/эквайринг
УТ 10.3
УТ 11
API/файлы
дневной
Сайт ↔ 1С
УТ 10.3
УТ 11 (после cutover)
стандартный обмен
регл.


7) Данные: маппинг, ключи, конфликты (см. 00‑Core §18)
Маппинг полей: таблица в приложении (единицы, НДС, валюты, статусы; преобразования и округления).
 Ключи: составные (№+дата+орг+склад)/GUID + md5(payload) — для дедупликации.
 Идемпотентность: окно 72 ч; повтор с тем же Idempotency‑Key и иным payload → 409 conflict.duplicate + ссылка на исходный ответ.
 Разрешение конфликтов: при разнонаправленных правках — приоритет SoT; для статусов — матрица правил (приложение; Status‑Dictionary v1).

8) Функциональные требования (эпики → DoD)
A1. Bulk‑НСИ (КД3) — разовая загрузка номенклатуры/контрагентов/складов в 11.
 DoD: контрольные выборки совпали; протокол несопоставленных обработан.
A2. Дельты НСИ (API) — отправляем только изменённые записи.
 DoD: p95 ≤ 60 c; повтор не даёт дубль; trace по X‑Correlation‑Id.
A3. «Зеркало» документов — ключевые документы из 10.3 в 11 для отчётов.
 DoD: p95 ≤ 120 c; нет дублей; отчёты сходятся на выборке.
A4. Перевод мастера (волнами) — по видам документов.
 DoD: 2 недели UAT без критичных; акт «0 критичных»; ночной cutover + план отката.
A5. Деньги (ПКО/РКО/подотчёт) — синхронизация черновиков и статусов.
 DoD: корректные суммы/НДС; отчёт «Должен/Сдал» — допуск ≤ 0,3%.
A6. Журнал/мониторинг — полная трассировка обменов.
 DoD: дашборд задержек/очередей; алерты 5xx/4xx/дубликаты; ретраи до 24 ч.

9) НФТ и лимиты (см. 00‑Core §2.7/§2.8/§8)
Производительность: MW p95 ≤ 400 мс без внешних вызовов; целевая пропускная способность до 50 rps, burst 100 rps ≤ 60 c.
 Лимиты API: payload ≤ 2 МБ, batch ≤ 500 строк; таймаут к внешним 10 c; retry 1м→5м→15м→1ч→3ч→12ч (см. 00‑Core §2.5, джиттер).
 SLO per объект: НСИ ≤ 60 c, Документы ≤ 120 c, ПКО ≤ 180 c; weekly error‑budget 0,1% 5xx.
 Доступность: MW ≥ 99,5%.
 Rate‑limit & CB: 600 rpm / 30 rps (бурст 2×/10 c); 429 с X‑RateLimit-*; circuit‑breaker для интеграций (открытие при 50% ошибок/60 c, полуоткрытое 30 c).
 JWT/Scopes: роли/скоупы согласно 00‑Core §2.6.
 Uploads/медиа: лимиты — как в API v1.1.3 (до 15 МБ на файл); кеш‑валидация по ETag.

10) Наблюдаемость, алерты, ретеншн (см. 00‑Core §8–§9)
Дашборды: задержка дельт, размер очередей, %5xx/%4xx, «дубликаты/1000 POST».
 Алерты (пороги): задержка НСИ > 10 мин — warn; > 30 мин — crit; %5xx > 0,1%/15 мин — crit; очередь > 10k — crit; дубликаты > 1/1000 — warn.
 Логи: JSON с X‑Correlation‑Id; маскирование ПДн.
 Retention: integration_log — 90 дн; task_events — 180 дн; idempotency_key — 72 ч.

11) Безопасность и доступы (см. 00‑Core §2.6/§9/§11)
Роли: админ / оператор / просмотр (минимально‑необходимые права).
 Секреты: менеджер секретов; ротация; аудит доступа.
 ПДн: TLS, Bearer/JWT; файлы/фото не храним в БД (только ссылки/ID); бэкапы шифруются.
 DPA с подрядчиком; DR‑учения 2 раза в год; RPO ≤ 15 мин, RTO ≤ 2 ч.

12) Тест‑план (вкл. негативные)
Negative/edge: частичный возврат с иной ставкой НДС; повторный POST с иным телом → 409 conflict.duplicate; оффлайн‑реплей без дублей; конфликт изменений 10.3↔11 — побеждает SoT.
 Performance/failover: x2 нагрузка «пик», имитация недоступности внешних сервисов, реплей очередей.
 DoR/DoD: на эпик/стори; UAT‑чеклисты — в приложении.

13) План релиза и «ворота» (см. 00‑Core §6.2/§6.3)
W1 — Подготовка: карта маппинга, КД3 bulk, MW v1, health/logs → Gate: согласована SoT‑матрица.
 W2 — Дельты + «зеркало»: дельты НСИ, зеркалирование документов, smoke‑тесты → Gate: UAT без критичных.
 W3 — Пилот: ввод части документов в 11 → Gate: KPI недели достигнуты.
 W4+ — Промышленная: перевод мастера по видам, отключение двойного ввода; переключение сайта на 11 (ночью).

14) Cutover runbook (фрагмент)
T‑1 дн: freeze справочников; бэкапы обоих контуров; smoke на стенде.
 T‑день: пауза дельт 5 мин; финальная дельта; переключение мастера; smoke‑чеклисты (заказы, реализация, ПКО).
 T+48 ч: усиленный мониторинг; акт сверки; решение о снятии «двойного журнала».

15) Коммуникации и обучение
Ритм: еженедельный статус‑репорт; демо раз в 2 недели.
 Материалы: 1–2 стр. инструкции для менеджеров/бухгалтерии + скринкаст 5–7 мин.
 Стейкхолдеры: карта ролей/контактов — в приложении.

16) Поддержка и гарантия
On‑call график (рабочие часы), приоритеты инцидентов и время реакции/восстановления.
 Гарантийный период 30 дней после cutover (исправления дефектов v1).

17) Оценка и ресурсы
Sizing: CPU/RAM/диск/IOPS для MW/БД; резервирование и бэкапы.
 Спринты: W1–W3 базовый объём; буфер рисков 20%.

18) Зависимости и риски
Версии стандартного обмена 1С↔Битрикс, лимиты API внешних систем.
 Топ‑риски: дубли/расхождения (см. §10), кастом 10.3 (аудит+стенд), сбои внешних (очереди/ретраи), человеческий фактор (обучение).
 Для каждого риска — владелец и план смягчения (реестр в приложении).

19) Критерии приёмки (UAT/DoD)
НСИ p95 ≤ 60 c; документы p95 ≤ 120 c; отчёт сверки: расхождения < 0,5% и без критичных.
 Повтор с тем же Idempotency‑Key возвращает прежний ответ (без дубля).
 ПКО/РКО/подотчёт — корректные суммы/НДС; «Должен/Сдал» ≤ 0,3%.
 Сайт переключён на УТ 11 и 48 ч — без красных алертов.
 Инструкции выданы; on‑call настроен.

Приложение A. OpenAPI anchors (см. 00‑Core §17; API‑Contracts v1.1.3)
/v1/nsi/* (номенклатура, цены, контрагенты, склады), /v1/docs/* (заказы/реализации/перемещения/возвраты), /v1/cash/* (ПКО/РКО/подотчёт), /v1/sync/* (дельты, реплеи, статус очередей).


Пагинация/фильтры: limit (1..100, по умолчанию 50), offset ≥ 0 либо page ≥ 1 (взаимоисключительны), sort=field:asc|desc (несколько полей через запятую), filter[field]=value (повторяемый; для диапазонов — filter[date_from]/filter[date_to]); см. единые правила Pagination & Filtering в API‑Contracts v1.1.3.


ETag/If-None-Match: кеш‑валидация GET/HEAD; weak‑ETag для списков.


Идемпотентность PATCH: PATCH‑вызовы идемпотентны и требуют Idempotency‑Key.


Deprecated: POST /api/v1/tasks/{id}/status — deprecated (Sunset объявлен).


Приложение B. 1С↔MW Mapping (см. 00‑Core §18)
Таблица полей/единиц/НДС/валют/статусов/округлений и ключей сопоставления; стратегия разрешения конфликтов.
 ER Freeze: используем v0.6.4 (включая домен currency_code и валидаторы возвратов).

