# NFR — MasterMobile Middleware

## Производительность и латентность
- **API чтения (GET/HEAD)**: базовый SLO p95 ≤ 400 мс, согласованный с 00‑Core §2.7; рабочие нагрузочные тесты подтверждают устойчивость до 200 RPS на инстанс.
- **API записи (POST/PUT/PATCH/DELETE)**: базовый SLO p95 ≤ 700 мс по 00‑Core §2.7; допускается кратковременный рост p95 до +20% при развёртывании.
- **Stretch-цель**: для критичных пользовательских сценариев удерживать p99 ≤ 2×p95, договорённость фиксируется в PRD конкретного потока.
- **Фоновые задачи**: 95% выполняются ≤ 30 секунд с момента постановки, DLQ не более 0.5% от общего потока.
- **События**: публикация и обработка CloudEvents p95 ≤ 2 секунды от момента записи в outbox.

## Доступность и надёжность
- Целевая доступность сервиса: 99.5% в месяц (бюджет простоя ≈ 3 ч 39 мин), значение выровнено с 00‑Core §2.7.
- RTO ≤ 2 часов, RPO ≤ 15 минут (см. 00‑Core §11). Регулярные проверки восстановления — не реже одного раза в неделю.
- PostgreSQL с синхронной репликацией в основной зоне, асинхронной в резервную. Автоматическое переключение ≤ 5 минут.
- Резервные копии БД: WAL каждые 15 минут, полные бэкапы ежедневно, с регулярными учениями восстановления.
- Redis с резервной репликой и snapshot каждые 15 минут.

## Масштабирование
- Автомасштабирование приложений при использовании CPU > 70% в течение 5 минут или при превышении SLA p95 на 20%.
- Минимум 3 реплики API в рабочее время, возможность масштабирования до 6 реплик за 10 минут.
- Redis и очередь задач масштабируются шардированием при задержках > 60 секунд.

## Безопасность и соответствие
- TLS 1.2+ для всех внешних и внутренних соединений.
- Авторизация по JWT Bearer: роли `admin`, `1c`, `courier`; обязательные скоупы `nsi.read`, `orders.write`, `returns.write`, `tasks.read`, `webhooks.sign` — см. 00‑Core §2.6.
- Срок жизни access-JWT 15 минут, refresh — 7 дней; допускаемое расхождение часов ≤ 30 секунд; JWKS-ротация не реже 90 дней.
- Обязательная ротация остальных секретов каждые 90 дней, аудит доступа ежеквартально.
- Логи и события безопасности передаются в SIEM с удержанием ≥ 180 дней; персональные данные маскируются до сохранения.

## Управляемость и наблюдаемость
- Логи: хранение ≥ 30 дней, корреляция по `X-Request-Id` и `Idempotency-Key`.
- Метрики и алерты: p95 latency, error rate, queue lag, DLQ. Реакция на критические алерты ≤ 15 минут.
- Трассировки: retention ≥ 7 дней, обязательное сохранение спанов `http.server`, `http.client`, `event.*`.

## Регламенты эксплуатации
- Регулярные нагрузочные тесты перед мажорными релизами: подтверждение устойчивости к ×2 пиковой нагрузке.
- Chaos-тесты для проверки отказоустойчивости не реже одного раза в квартал.
- Postmortem для всех инцидентов `sev1` и `sev2` в течение 48 часов.
