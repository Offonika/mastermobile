# NFR — MasterMobile Middleware

## Латентность и пропускная способность
- **Чтение (GET, HEAD)**: p95 ≤ 150 мс, p99 ≤ 300 мс при RPS ≤ 200 на инстанс.
- **Запись (POST, PUT, PATCH, DELETE)**: p95 ≤ 250 мс, p99 ≤ 500 мс при RPS ≤ 120 на инстанс.
- **Фоновая обработка задач**: 95% задач завершаются за ≤ 30 секунд с момента постановки в очередь.
- **SLO мониторинга**: ежемесячный бюджет ошибок 43 минуты (99.9% доступности). Превышение бюджета требует плана восстановления SLO.

## Ограничения на payload
- Максимальный размер входящего HTTP-тела: 512 КБ для синхронных запросов, 2 МБ для multipart загрузок.
- Ответы API должны оставаться ≤ 1 МБ; при превышении — разбивать на страницы или выдавать ссылки на выгрузку.
- Заголовок `Content-Encoding: gzip` обязателен для ответов > 64 КБ.

## Таймауты
- Клиентские HTTP-запросы к middleware: 5 секунд (hard timeout), при ожидании транзакций — 8 секунд.
- Таймаут подключения к базе данных: 2 секунды, таймаут запроса: 1 секунду для чтения, 2 секунды для записи.
- Внешние интеграции (Bitrix24, 1С) вызываются через gateway с общим таймаутом 10 секунд и circuit breaker на 30 секунд при деградации.
- Очереди фоновых задач: ack timeout 60 секунд; при превышении задача помещается в dead-letter.

## Ретраи
- Идемпотентные операции чтения: до 2 повторов с экспоненциальной паузой 200/400 мс.
- Запросы записи допускают 1 повтор при наличии корректного `Idempotency-Key`; повтор без ключа запрещён.
- Вызовы внешних интеграций: 3 попытки с джиттером, общее время ретраев ≤ 15 секунд, затем срабатывает circuit breaker.
- Повтор фоновых задач: до 5 попыток с экспоненциальной задержкой до 15 минут; после исчерпания — ручной разбор.

## Надёжность
- Доступность middleware: 99.9% в месяц; RTO ≤ 15 минут, RPO ≤ 5 минут.
- Репликация базы данных: синхронная внутри основного кластера и асинхронная в резервный регион.
- Резервное копирование: инкрементальные бэкапы каждые 15 минут, полный — раз в сутки, хранение ≥ 30 дней.
- Обязателен хаос-тест (fault injection) не реже одного раза в квартал с фиксацией результатов.

## Масштабирование
- Горизонтальное масштабирование приложений: auto-scale при p95 > 70% от SLO или нагрузке > 70% CPU/мем.
- Целевой объём: 3 активных инстанса в рабочее время, возможность увеличения до 6 в течение 10 минут.
- Redis и очередь задач масштабируются с репликацией и шардированием при RPS > 500 или задержках > 50 мс.
- Нагрузочные тесты проводятся перед каждым крупным релизом, цель — подтвердить устойчивость к 2× пику нагрузки.
