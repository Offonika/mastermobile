# NFR — MasterMobile Middleware

## Производительность и латентность
- **API чтения (GET/HEAD)**: p95 ≤ 150 мс, p99 ≤ 300 мс при нагрузке до 200 RPS на инстанс.
- **API записи (POST/PUT/PATCH/DELETE)**: p95 ≤ 250 мс, p99 ≤ 500 мс при нагрузке до 120 RPS.
- **Фоновые задачи**: 95% выполняются ≤ 30 секунд с момента постановки, DLQ не более 0.5% от общего потока.
- **События**: публикация и обработка CloudEvents p95 ≤ 2 секунды от момента записи в outbox.

## Доступность и надёжность
- Целевая доступность сервиса: 99.9% в месяц (бюджет простоя ≤ 43 мин) — согласовано с владельцами продукта и эксплуатации (см. [Протокол синка 24.09.2025](https://confluence.example.com/display/MM/2025-09-24+SRE%2FProduct+sync)).
- RTO ≤ 15 минут, RPO ≤ 5 минут (источник: тот же протокол). Регулярные проверки бэкапов раз в квартал.
- PostgreSQL с синхронной репликацией в основной зоне, асинхронной в резервную. Автоматическое переключение ≤ 5 минут.
- Redis с резервной репликой и snapshot каждые 15 минут.

## Масштабирование
- Автомасштабирование приложений при использовании CPU > 70% в течение 5 минут или при превышении SLA p95 на 20%.
- Минимум 3 реплики API в рабочее время, возможность масштабирования до 6 реплик за 10 минут.
- Redis и очередь задач масштабируются шардированием при задержках > 60 секунд.

## Ограничения API и устойчивость интеграций
- **Размеры payload**:
  - JSON и batch-запросы ограничены телом ≤ 2 МБ и партиями ≤ 500 строк; превышение приводит к `413 Payload Too Large` и фиксации события в журнале интеграций для ручного разбора.
  - Фотографии и иные бинарные вложения должны быть ≤ 15 МБ; мобильные клиенты сжимают медиа до 1.5–2 МБ перед отправкой.
- **Таймауты и ретраи HTTP-клиентов**:
  - Исходящие вызовы к 1С и Bitrix24 выполняются с `REQUEST_TIMEOUT_S = 30` секунд (см. переменную окружения в `.env`); таймаут инициирует экспоненциальный backoff 1м → 5м → 15м → 1ч → 3ч → 12ч (с джиттером), после чего задача уходит в DLQ/ручную обработку.
  - Для доставки вебхуков и публикации событий действует тот же лимит ожидания: совокупное время ретраев ограничено 24 часами, затем событие переводится в DLQ.
- **Политика circuit breaker**:
  - При доле ошибок/таймаутов ≥ 50% за 60 секунд коннектор переходит в открытое состояние на 30 секунд, блокируя новые попытки; успешные проверки в полуоткрытом режиме возвращают его в нормальный режим, повторные сбои продлевают окно блокировки.
  - Во время открытого состояния клиенты получают защитные ответы (`503 Service Unavailable`, `integration.timeout_*`), а алерты строятся по метрикам `integration_failures_total` и росту доли ошибок `integration.timeout_*`.

## Безопасность и соответствие
- TLS 1.2+ для всех внешних и внутренних соединений.
- Аутентификация по JWT c ролями `1c`, `courier`, `admin` (см. «00‑Core — Синхронизация документации», §2.6); refresh токены хранятся только на доверенных backend.
- Обязательная ротация секретов каждые 90 дней, аудит доступа ежеквартально.
- Логи и события безопасности передаются в SIEM с удержанием ≥ 180 дней.

## Управляемость и наблюдаемость
- Логи: хранение ≥ 30 дней, корреляция по `X-Request-Id` и `Idempotency-Key`.
- Метрики и алерты: p95 latency, error rate, queue lag, DLQ. Реакция на критические алерты ≤ 15 минут.
- Трассировки: retention ≥ 7 дней, обязательное сохранение спанов `http.server`, `http.client`, `event.*`.

## Регламенты эксплуатации
- Регулярные нагрузочные тесты перед мажорными релизами: подтверждение устойчивости к ×2 пиковой нагрузке.
- Chaos-тесты для проверки отказоустойчивости не реже одного раза в квартал.
- Postmortem для всех инцидентов `sev1` и `sev2` в течение 48 часов.
