<!-- filename: docs/nfr.md -->

# NFR — MasterMobile Middleware

## Производительность и латентность
- **API чтения (GET/HEAD)**: p95 ≤ 150 мс, p99 ≤ 300 мс при нагрузке до 200 RPS на инстанс.
- **API записи (POST/PUT/PATCH/DELETE)**: p95 ≤ 250 мс, p99 ≤ 500 мс при нагрузке до 120 RPS.
- **Фоновые задачи**: 95% выполняются ≤ 30 секунд с момента постановки, DLQ не более 0.5% от общего потока.
- **События**: публикация и обработка CloudEvents p95 ≤ 2 секунды от момента записи в outbox.

## Доступность и надёжность
- Целевая доступность сервиса: 99.9% в месяц (бюджет простоя ≤ 43 мин).
- RTO ≤ 15 минут, RPO ≤ 5 минут. Регулярные проверки бэкапов раз в квартал.
- PostgreSQL с синхронной репликацией в основной зоне, асинхронной в резервную. Автоматическое переключение ≤ 5 минут.
- Redis с резервной репликой и snapshot каждые 15 минут.

## Масштабирование
- Автомасштабирование приложений при использовании CPU > 70% в течение 5 минут или при превышении SLA p95 на 20%.
- Минимум 3 реплики API в рабочее время, возможность масштабирования до 6 реплик за 10 минут.
- Redis и очередь задач масштабируются шардированием при задержках > 60 секунд.

## Безопасность и соответствие
- TLS 1.2+ для всех внешних и внутренних соединений.
- Аутентификация по JWT c ролями `1c`, `courier`, `admin` (см. «00‑Core — Синхронизация документации», §2.6); refresh токены хранятся только на доверенных backend.
- Обязательная ротация секретов каждые 90 дней, аудит доступа ежеквартально.
- Логи и события безопасности передаются в SIEM с удержанием ≥ 180 дней.

## Управляемость и наблюдаемость
- Логи: хранение ≥ 30 дней, корреляция по `X-Request-Id` и `Idempotency-Key`.
- Метрики и алерты: p95 latency, error rate, queue lag, DLQ. Реакция на критические алерты ≤ 15 минут.
- Трассировки: retention ≥ 7 дней, обязательное сохранение спанов `http.server`, `http.client`, `event.*`.

## Регламенты эксплуатации
- Регулярные нагрузочные тесты перед мажорными релизами: подтверждение устойчивости к ×2 пиковой нагрузке.
- Chaos-тесты для проверки отказоустойчивости не реже одного раза в квартал.
- Postmortem для всех инцидентов `sev1` и `sev2` в течение 48 часов.
