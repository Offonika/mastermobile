PRD «Ходячий склад» — v1.3.2 (синхронизировано)
Основано на: ONE-PAGER v1.3, 00‑Core v1.3, API‑Contracts v1.1.3, ER Freeze v0.6.4
 Дата: 18.09.2025
 Цель: Запуск прозрачного процесса курьерской доставки и возвратов в УТ 10.3 без миграции на УТ 11, с «рюкзаком курьера» для допродаж.

1. Зачем (коротко)
Проблема. В УТ 10.3 нет стабильного контура доставки; обмен с сайтом нестабилен.
 Цель v1 (2–3 недели). Заказ → задача курьеру в Bitrix24 ≤10 с → фото/гео подтверждения → расчёт (наличные через «Деньги в пути») → закрытие → отчёты. Плюс «рюкзак курьера» для допродаж «с места». Возвраты — единым процессом: через курьера и через менеджера.
Scope v1 (что делаем):
1С: кнопка «Отправить в B24 (курьер)», авто‑статус «Готов (B24)», нужные поля заказа, хранение TaskIdB24 и IdempotencyKey.


Перемещений «на заказ» не создаём (см. раздел «Доставка»).


Склады курьеров по подразделениям и кассы «Деньги в пути — <Подразделение>».


Middleware (FastAPI): интеграция 1С↔B24, очередь повторов, защита от дублей, логирование, отчёты.


Bitrix24: задачи с адресом/телефоном/COD, фото, маршрут, ссылка на виджет.


Виджет/PWA «Рюкзак/Продажа»: скан QR заказа и штрихкодов, оффлайн, фото‑контроль, инвентаризация рюкзака, продажа «с места».


Возвраты:


через курьера — инициация возврата (событие return_ready в MW) без создания нового документа в 1С; менеджер позже оформляет стандартный «Возврат товаров от покупателя» через мастер;


через менеджера — по реализации (даже другого подразделения) строго «на основании».


Вне v1 (позже): живой GPS‑трек, авто‑маршрутизация, ML‑рекомендации, автопополнение рюкзака, нативное приложение.



2. Роли и ключевые сценарии (простым языком)
Менеджер (1С)
M1. «Отправить в B24». Нажимаю кнопку — у курьера появляется задача ≤10 с; заказ получает статус «Готов (B24)»; в 1С сохраняются TaskIdB24 и IdempotencyKey. Антидубль: повтор с тем же ключом не создаёт второй задачи. При «Самовывозе» — кнопка недоступна.


M2. «Положить в рюкзак». Добавляю сопутствующие товары курьеру (перемещение на «Склад курьеров — <Подразделение>»). Остатки в виджете обновляются ≤60 с.


M3. «Подтвердить быструю продажу». Подтверждаю черновик заказа со склада курьеров. Сумма считается корректно.


M4. «Возврат через менеджера (КПП‑4)». Запускаю мини‑мастер: ввожу контрагента и товар/серия/IMEI. Система находит реализацию даже у другого подразделения и формирует документ «Возврат товаров от покупателя» строго на её основании. Частичный возврат — можно (остаток).


Курьер (Bitrix24 + виджет)
C1. «Вижу рюкзак». Остатки и цены доступны, работает оффлайн; могу сканировать штрих‑коды и QR заказа.


C2. «Продажа из рюкзака». Оформляю продажу со склада курьеров; в 1С создаётся черновик; вижу «К оплате».


C3. «Фото и гео». Делаю фото на этапах «забрал/отдал/сдал деньги»; гео‑чек‑ин на «Старт» и «Отдан» (допуск ≤100 м).


C4. «Принять возврат». Жму «Принять возврат» → сканирую штрих/IMEI, отмечаю качество и причину, прикладываю фото. Кнопка недоступна без сети.


Логист / Руководитель доставки
L1. Канбан. Вижу стадии, переназначаю исполнителя. Перенос отражается в 1С.


L2. Исключения. «Отмена», «Перенос», «Частично выдано» — доступны; клиент получает уведомление; суммы/статусы обновляются.


Бухгалтер/Кассир
B1. Наличные. При получении наличных у клиента долг закрывается сразу — деньги попадают в «Деньги в пути — подразделение заказа». В конце смены: перемещение «Деньги в пути → Касса подразделения».


B2. Возврат денег клиенту. В v1 возвращаем только безналично: бухгалтерия делает выплату после проведения документа возврата. Наличный возврат «у двери» выключен (можно включить позже по роли/лимиту отдельным флагом).



3. Как это работает (потоки)
3.1 Доставка
Сборка (1С) → Отправить в B24 (≤10 с — задача курьеру; статус «Готов (B24)»).
 Перемещений «на заказ» не создаём. Печатается QR заказа при статусе «Готов (B24)».
 Курьер «Забрал» (фото) → «Старт» (гео) → «Отдан» (фото + сумма/COD, гео).
 Если наличные: ПКО в «Деньги в пути — <Подразделение>».
 «Сдача денег» (фото) → перемещение «В пути → Касса» → «Закрыт».
3.2 Рюкзак / Допродажа
«Положить в рюкзак» (1С, перемещение) → остаток виден в виджете → продажа (скан) → черновик в 1С (склад курьеров) → подтверждение → оплата/«Деньги в пути».
3.3 Возвраты
Через курьера. Курьер принимает возврат в виджете (скан, качество, причина, фото) → MW валидирует и фиксирует событие return_ready; товар в рюкзаке уходит в ячейку «Возвраты» (не для продажи) до сдачи на базе; в 1С документов пока нет — менеджер позже оформляет стандартный возврат через мастер.
 Через менеджера (КПП‑4). Менеджер запускает внешнюю обработку — мастер возврата. По IMEI/серии мастер серверно находит реализацию (поиск выполняется в MW без доступа к чужим журналам) и сразу создаёт стандартный документ «Возврат товаров от покупателя» (черновик) на основании реализации: строки, цены/НДС, серия/IMEI, поля Качество/Причина; действует антидубль — к возврату доступен только остаток по каждой строке.
 При приёмке на базе менеджер проводит черновик:
Качество = «новый» → товар на склад возвратов (или по принятой политике).


Качество = «брак» → на склад «Карантин/Возвраты» (проверка).
 Если брак не принят по результатам проверки — черновик не проводим и удаляем/отклоняем (в 1С движений не было и нет); в MW ставится статус return_rejected, клиенту уходит уведомление «Возврат не одобрен: {причина}», а в Bitrix24 создаётся подзадача «Вернуть товар клиенту» (адрес/контакт/дедлайн). Курьер возвращает товар клиенту, фиксирует фото передачи, подзадача закрывается.


Кто ставит и как фиксируется return_rejected.
 Кто: сотрудник приёмки/контроля качества (роль «Приёмка/КК») или назначенный менеджер по возвратам в 1С.
 Где: в мастере возврата (внешняя обработка) для строк с Качество = «брак» доступны действия: «Принять брак» (проводим) и «Отклонить брак» (не проводим).
 Как: при «Отклонить брак» 1С не проводит документ и удаляет/отклоняет черновик, одновременно вызывает MW:
 POST /api/v1/returns/{return_id}/reject
 body: {reason, items:[{line_id, sku, qty}], actor:{id_1c, fio}}
 headers: Idempotency-Key, X-Correlation-Id.
 MW ставит return_rejected, пишет аудит, создаёт в B24 подзадачу «Вернуть товар клиенту» и отправляет клиенту уведомление.
 Откуда берётся return_id: если возврат стартовал у курьера — присвоен при событии return_ready; если стартовал у менеджера — присваивается при создании черновика мастером (return_draft_created) и отображается в форме.
 Идемпотентность: повторный вызов reject с тем же Idempotency-Key возвращает тот же результат; частично принятые строки к отклонению недоступны.

4. Учёт в 1С (документы и объекты)
Склады: по одному «Склад курьеров — <Подразделение>» на подразделение.
 Кассы: «Деньги в пути — <Подразделение>».
Движения:
На кнопку «Отправить в B24» движений не создаём (перемещения — только для «Рюкзака» и возврата остатков).


«Допродажа из рюкзака» → Реализация со склада курьеров.


«Возврат остатка» → Перемещение обратно на базу.


«Отдан (наличные)» → ПКО в «Деньги в пути»; в конце смены — перемещение «В пути → Касса».


Возврат (через курьера) → событие return_ready в MW (без «Заявки на возврат» в 1С); менеджер оформляет стандартный «Возврат товаров от покупателя».


QR/штрихкоды: заказ — QR (печатается при «Готов (B24)», содержит id/сумму/контроль); товары — штрих/IMEI для проверки состава и для возвратов. Если код не читается — ручной ввод + обязательное фото.

5. Политики фото/гео/скана
Фото: обязательно на «забрал/отдал/сдал деньги/возврат»; контроль резкости/размера.


Гео: чек‑ин на «Старт» и «Отдан»; допуск ≤100 м, «живёт» ≤10 мин.


Скан: ≥95% движений должны быть по скану (товары/заказы).



6. Отчёты и контроль
«Рюкзак курьера» — остатки и допродажи.


«Возвраты в пути» — товары у курьеров, ещё не подтверждены менеджером.


«Возвраты принятые» — оформленные документы в 1С.


Сверка «Деньги в пути» vs касса; отчёт «Должен/Сдал» (допуск по расхождениям ≤0,3%).


6a. Уведомления клиенту
«Заказ №{N} передан курьеру. К оплате: {sum} ₽».


«Курьер в пути. Покажите QR‑код при получении».


«Получение подтверждено. Принято {paid} ₽. Остаток: {rest} ₽».


«Возврат принят. Сумма к возврату: {sum} ₽. Деньги будут возвращены безналично».


При отказе по браку: «Возврат не одобрен: {причина}. Товар будет возвращён {доставим/выдача на базе}».


6b. Справочник сопутствующих товаров (v1)
Регистр сведений СопутствующиеТовары: ОсновнаяНоменклатура, СопутствующаяНоменклатура, Подразделение (опц.), Канал (Доставка/Рюкзак/Магазин), Приоритет, КолВоПоУмолчанию, Обязательный, ЛимитВРюкзак (опц.), Активен, ПериодНач/Окон, Комментарий.
 Правила (опц.) ПравилаСопутствующих: по группам/брендам/свойствам (разъём, диагональ) для массовых подсказок.
 Где используется: кнопка «Сопутствующие» в заказе и мастер «Положить в рюкзак» (учитывает текущие остатки рюкзака).
6c. Алерты/метрики
Создание подзадачи курьеру и уведомления клиенту после return_rejected — ≤ 60 с (p95).


Возвраты в статусе return_ready старше 1 дня — эскалация (ответственный: Руководитель доставки).



7. KPI / «Как поймём, что всё работает»
«Готов → Отдан» — быстрее на 20% против базовой линии.


≥95% доставок без возврата.


Допродажи +7–15% (медиана на задачу ≥400 ₽).


Разница по наличным ≤0,3%.


Точность остатков рюкзака ≥98%.


Возвраты: return_ready → проведено (документ «Возврат товаров от покупателя») ≤ 1 рабочего дня.


По return_rejected: подзадача «Вернуть товар клиенту» создана и закрыта; движений в 1С нет.



8. Нефункциональные требования (по‑простому)
Надёжность: доступность API 99,5%, таймауты 10 с, повторы до 24 ч; защита от дублей по Idempotency‑Key.


Скорость: кнопка в 1С → задача в B24 ≤10 с (p95); «Отдан (курьер)» → уведомление клиенту ≤60 с; «Отдан (наличные)» → ПКО в «Деньги в пути» ≤5 мин.


Оффлайн: виджет работает оффлайн: скан/фото/сумма накапливаются и отправляются при появлении сети; возврат — только online (кнопка недоступна без сети).



9. Безопасность и ПДн
Телефон, адрес, фото — храним в B24; в БД — только ссылки/ID.


Маскируем телефоны/суммы в логах.


Ретенции: фото ≤90 дн, гео ≤30 дн, integration_log ≥ 90 дн, task_events ≥ 180 дн, idempotency‑keys 72 ч.


HTTPS, токены, allowlist IP; роли/доступы: курьер — свои задачи и рюкзак; менеджер — свои заказы; админ — всё. Привилегированный поиск реализации выполняется на стороне MW; в 1С не открываются чужие журналы.



10. DoD / UAT (приёмка)
Из 1С создаётся задача в B24 ≤10 с; в 1С видны TaskIdB24 и статус «Готов (B24)».


Фото доступны; гео фиксируется на двух точках (допуск ≤100 м).


Рюкзак показывает верные остатки; свёртка движений корректная.


Продажа из рюкзака создаёт черновик; повтор с тем же Idempotency‑Key не даёт дубль.


При «Отдан (наличные)» — ПКО в «Деньги в пути», уведомление клиенту ≤60 с.


Отчёт «Итоги по курьеру/дню» сходится по суммам.


Скан ≥95% движений; точность рюкзака ≥98%.


UAT‑матрица «скан/фото/оффлайн»: бликует/мятая наклейка/ночь/низкая батарея/нет сети/повторная отправка — пройдена.


Совместимость API: статус задачи обновляется PATCH /api/v1/tasks/{id} (метод /status — deprecated в 1.1.x).



11. План запуска (пилот 3 недели)
Неделя 1. MW + интеграция B24, поля задач, лог интеграции, генерация/печать QR, троттлинг.


Неделя 2. 1С (кнопки, склады/кассы, свёртка движений), виджет (сканер, оффлайн), ПКО/перемещения.


Неделя 3. Пилот 1–2 курьера, UAT (матрица скан/фото/оффлайн), обучение, релиз.



12. Флаги и откат
Флаги: кнопка в 1С; допродажа из рюкзака; отправка уведомлений; свёртка движений; возвраты через курьера; наличный возврат у двери (выключено).


Откат: выключаем флаг → работаем по инструкции вручную, очередь сообщений сохраняется, данные не теряются.



13. Глоссарий
Рюкзак — виртуальный мини‑склад у курьера для выдачи заказов и допродаж.


Наложка (COD) — сумма к получению при вручении.


ПКО/РКО — приходный/расходный кассовый ордер.


Деньги в пути — промежуточная касса подразделения до сдачи в реальную кассу.


Idempotency‑Key — уникальный ключ, чтобы повтор не создавал дублей.


X‑Correlation‑Id — сквозной идентификатор для трассировки в логах.



14. Соответствие ONE‑PAGER v1.3 (что точно войдёт в v1)
1С: кнопка «Отправить в B24 (курьер)», авто‑статус «Готов (B24)», поля заказа, TaskIdB24, движение «Деньги в пути», склады курьеров, оформление возвратов только стандартным документом «Возврат товаров от покупателя» (без отдельной «Заявки на возврат»).


Middleware: интеграция 1С↔B24, очередь повторов, защита от дублей, логи, отчёты.


Bitrix24: задачи с полями и фото, ссылка на виджет.


Виджет курьера: скан QR/штрихкодов, оффлайн, допродажа, фото «забрал/отдал/сдача/возврат».


Изменения против v0.4 (что уточнили):
Убрали упоминание отдельного чернового документа «Заявка на возврат» в 1С; вместо него — событие return_ready в MW и последующее оформление стандартного возврата менеджером.


Выровняли Retention: integration_log ≥ 90 дн; task_events ≥ 180 дн; idempotency‑keys 72 ч.


Зафиксировали совместимость API: обновление статуса задачи — PATCH /api/v1/tasks/{id}.


Синхронизировали с ER Freeze v0.6.4 (валюта, индексы, валидаторы возвратов).



