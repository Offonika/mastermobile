# План запуска middleware v1

## Исходные артефакты
- [SRS — Core Sync 1С: УТ 10.3 ↔ УТ 11](SRS — Core Sync 1С: УТ 10.md) — техническая спецификация обмена и cutover.
- [PRD «Ходячий склад»](PRD Ходячий склад.md) — требования к доставке, «рюкзаку» и возвратам.
- [Концепция проекта](Концепция проекта.md) — общие цели программы перехода и Walking Warehouse.
- [API‑Contracts v1](API‑Contracts.md) и [ER‑диаграмма и DDL](ER‑диаграмма и DDL.md) — согласованные интерфейсы и структура данных.

## Цели релиза v1
1. Поднять middleware как «почтальона» между УТ 10.3 и УТ 11 с гарантиями идемпотентности, журналом интеграции и очередями повторов для SoT=10.3 на старте, согласно SRS.
2. Запустить поток «Ходячий склад» с кнопкой «Отправить в B24», статусами доставки, фото/гео контролем и операциями «Рюкзак/Продажа», сохранив финансовый контроль (допуск по наличным ≤0,3%).
3. Подготовить cutover и UAT: выдержать SLA дельт (НСИ ≤60 с, документы ≤120 с), обеспечить отчётность и план отката.

## Этапы и ключевые работы
### Этап 0. Подготовка инфраструктуры (неделя 0)
- Развёртывание окружений DEV→TEST→UAT→PROD с раздельными секретами и анонимизацией тестовых данных.
- Настройка CI/CD: blue‑green/rolling деплой FastAPI с health‑чеками и автооткатом при деградации SLO.
- Подготовка наблюдаемости: метрики задержек дельт, длины очередей, %5xx/%4xx, дубликатов/1000 POST; алерты warn (>10 мин) и crit (>30 мин, %5xx>0,1%/15 мин, очередь>10k).
- Организация менеджера секретов, TLS 1.2+, маскирование телефонов и адресов в логах; шифрование бэкапов.

### Этап 1. Core Sync: НСИ и документы (недели 1–2)
- Реализовать bulk‑загрузку НСИ (КД3) с протоколом несопоставленных записей и дельты НСИ с p95 ≤60 с, поддержкой отложенных зависимостей.
- Построить зеркалирование документов (заказ, реализация, поступление, перемещение, списание, оприходование, инвентаризация, возвраты) с временем появления в УТ 11 ≤120 с без дублей.
- Синхронизировать деньги (ПКО/РКО/подотчёт) с разделением «товар/доставка», контролем отчёта «Должен/Сдал» (дельта ≤0,3%).
- Обеспечить идемпотентность через заголовок Idempotency‑Key (TTL окна 72 ч); очередь ретраев с backoff 1м→5м→15м→1ч→3ч→12ч и гарантированной доставкой ≤24 ч.
- Настроить журнал интеграции (JSON, ts, correlation_id, статус, тело/хэш) с retention integration_log ≥90 дн, task_events ≥180 дн.

### Этап 2. Walking Warehouse и рюкзак (недели 2–3)
- Добавить в 1С кнопку «Отправить в B24» с созданием задачи курьеру ≤10 с, статусом «Готов (B24)», хранением TaskIdB24 и Idempotency-Key, недоступностью при самовывозе.
- Реализовать перемещения «Положить в рюкзак» на склады курьеров и обновление остатков в виджете ≤60 с; оформить черновик реализации по продаже из рюкзака и подтверждение менеджером.
- Обеспечить сценарий возврата через курьера: событие return_ready без создания документа в 1С, фотографирование и гео‑контроль, перевод товара в ячейку «Возвраты».
- Реализовать мастер возврата для менеджера (КПП‑4) с поиском реализации по IMEI/серии в MW, созданием черновика «Возврат товаров от покупателя» строго на основании исходной реализации и антидублем.
- Внедрить операцию return_rejected через API `/api/v1/returns/{return_id}/reject` с идемпотентностью и автоматическим уведомлением клиента и подзадачей в B24.
- Обеспечить политики фото (обязательно «забрал/отдал/сдал деньги/возврат»), гео (чек‑ин на «Старт» и «Отдан», допуск ≤100 м) и скана (≥95% операций — по штрих‑коду/QR).

### Этап 3. Cutover, UAT и операционка (недели 3–4)
- Подготовить миграцию: snapshot КД3 → прогон дельт → короткий freeze → ночной cutover по видам документов; план отката с переключением флага мастера и реплеем очередей.
- Провести UAT: pass‑rate ≥98% за 7 дней, дельты p95 ≤120 с, акт «0 критичных»; обеспечить мониторинг зелёный 48 ч на стенде и готовность on‑call.
- Сформировать отчёты: «Рюкзак курьера», «Возвраты в пути», «Возвраты принятые», сверка «Деньги в пути» vs касса.
- Проверить уведомления клиенту для доставки, оплаты, возврата и отклонения возврата.
- Подготовить инструкции и обучение менеджеров/курьеров (30‑минутные сессии), назначить владельцев процессов и контрольную группу.

## Критерии готовности
- SLA дельт: НСИ ≤60 с, документы ≤120 с, ПКО ≤180 с; MW p95 ≤400 мс, throughput 50 rps (burst 100 rps ≤60 с).
- Доступность MW ≥99,9% (месяц, 43 мин простоя); RPO ≤5 мин, RTO ≤15 мин.
- Повторный вызов с тем же Idempotency‑Key возвращает исходный ответ без дубля.
- Контроль наличных: отчёт «Должен/Сдал» ≤0,3%; доставка «Готов → Отдан» быстрее на 20%, ≥95% доставок без возврата.
- Cutover сайта на УТ 11 проходит 48 ч без красных алертов; уведомления клиенту и создание подзадач после return_rejected ≤60 с.

## Риски и меры
- Дубли/расхождения — покрыты идемпотентностью, антидублями в БД и регулярными отчётами сверки.
- Сбои внешних систем — очереди/ретраи, разделение потоков, алерты warn/crit и on‑call.
- Кастом 10.3 — аудит, тестовый стенд, ночные переключения, готовый план отката.
- Человеческий фактор по наличным и возвратам — обязательные шаги, фото/гео‑контроль, обучение и эскалации для просроченных возвратов (>1 дня).
