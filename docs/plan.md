# План запуска middleware v1

## Исходные артефакты
- [PRD — «Ассистент мастера»](PRD%20—%20«Ассистент%20мастера».md) — сценарии Telegram-бота для поиска/заказов/возвратов и пилотные KPI.
- [Концепция проекта](Концепция%20проекта.md) — общие цели программы перехода и Walking Warehouse.
- [API‑Contracts v1](API‑Contracts.md) и [ER‑диаграмма и DDL](ER‑диаграмма%20и%20DDL.md) — согласованные интерфейсы и структура данных.
- [PRD «Ходячий склад»](PRD%20Ходячий%20склад.md) — артефакты смежных потоков (учитываем при стыковке, но реализацию откладываем).

## Цели релиза v1
1. Вывести в прод «Ассистента мастера» как основной канал заявок: Telegram-бот с поиском, корзиной, оформлением заказов (prepaid и COD «Неси»), сопровождением возвратов и degraded mode.
2. Обеспечить наблюдаемость и устойчивость ассистента: единый формат ошибок, идемпотентность, rate limits, метрики/алерты и UAT пилота (golden-set `docs/NLU/golden_set.csv`, нагрузочные проверки, KPI).

> В рамках текущего релиза явно откладываем Core Sync, Walking Warehouse и cutover: задачи остаются в бэклоге и возвращаются после стабилизации «Ассистента мастера».

## Этапы и ключевые работы
### Этап 0. Подготовка инфраструктуры (неделя 0)
- Развёртывание окружений DEV→TEST→UAT→PROD с раздельными секретами и анонимизацией тестовых данных.
- Настройка CI/CD: blue‑green/rolling деплой FastAPI с health‑чеками и автооткатом при деградации SLO.
- Подготовка наблюдаемости: метрики задержек дельт, длины очередей, %5xx/%4xx, дубликатов/1000 POST; алерты warn (>10 мин) и crit (>30 мин, %5xx>0,1%/15 мин, очередь>10k).
- Организация менеджера секретов, TLS 1.2+, маскирование телефонов и адресов в логах; шифрование бэкапов.

### Этап 1. Ассистент мастера (недели 1–2)
- Собрать MVP Telegram-бота: голос/текст, маршруты `/find`, `/order`, `/bring`, `/cart`, `/myorders`, `/track`, `/return`, `/howto`, `/compat` в соответствии с PRD.
- Интегрировать бота с API сайта 1С-Битрикс: поиск карточек, прайс/остатки, создание заказов (prepaid и COD «Неси»), корзина, трекинг и RMA, соблюдая единый формат ошибок и идемпотентность.
- Настроить аутентификацию через Telegram Login Widget → JWT сайта, хранение X-User-Token и rate limits; внедрить логи, метрики и алерты (latency, error rate, no-result, COD-share, degraded_mode).
- Реализовать degraded mode (кэш выдачи, уведомления) и минимальные техподсказки (prompt-only) с CTA «Заказать комплект».
- Подготовить UAT пилота: golden-set (`docs/NLU/golden_set.csv`) на 100 запросов, нагрузочные проверки (500 запросов), happy-path COD-заказ, критерии KPI (CTR, конверсия, F1, SLA ответов).

### Этап 2. Пост-релизное развитие (бэклог)
- Подготовить к запуску Core Sync и Walking Warehouse: выстроить приоритеты, скорректировать зависимости, поддерживать консистентность с API‑Contracts и ER.
- Актуализировать план cutover после подтверждения стабильности ассистента (результаты UAT, поддержка on-call, подтверждённые SLA).
- Согласовать кросс-функциональные ресурсы (интеграции, логистика, back-office) и провести ревью требований перед стартом следующей фазы.

## Критерии готовности
- MW p95 ≤400 мс на основных сценариях ассистента, throughput 50 rps (burst 100 rps ≤60 с).
- Доступность ассистента ≥99,5% в пилоте; RPO ≤5 мин, RTO ≤15 мин.
- Повторный вызов с тем же Idempotency‑Key возвращает исходный ответ без дубля.
- UAT пилота: golden-set (`docs/NLU/golden_set.csv`) ≥95% успешных ответов, happy-path COD-заказ и возврат закрываются без ручных вмешательств, SLA ответов ≤3 с.
- Метрики и алерты настроены: latency, error rate, no-result, COD-share, degraded_mode.

## Риски и меры
- Сбои внешних систем (Bitrix, Telegram) — очереди/ретраи, разделение потоков, алерты warn/crit и on-call.
- Недостаточная полнота ассортимента и ошибки карточек — мониторинг no-result, регулярный фидбек в контент-команду, fallback-подсказки мастеру.
- Человеческий фактор по наличным и возвратам — обязательные шаги, фото/гео‑контроль, обучение и эскалации для просроченных возвратов (>1 дня).
- Утечки данных или ошибки анонимизации — менеджер секретов, маскирование телефонов и адресов, регулярные ревью логов.
