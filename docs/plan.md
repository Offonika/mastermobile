# План запуска middleware v1

## Исходные артефакты
- [PRD — «Ассистент мастера»](PRD — «Ассистент мастера».md) — сценарии Telegram-бота для поиска/заказов/возвратов и пилотные KPI.
- [SRS — Core Sync 1С: УТ 10.3 ↔ УТ 11](SRS — Core Sync 1С: УТ 10.md) — техническая спецификация обмена и cutover.
- [PRD «Ходячий склад»](PRD Ходячий склад.md) — требования к доставке, «рюкзаку» и возвратам.
- [Концепция проекта](Концепция проекта.md) — общие цели программы перехода и Walking Warehouse.
- [API‑Contracts v1](API‑Contracts.md) и [ER‑диаграмма и DDL](ER‑диаграмма и DDL.md) — согласованные интерфейсы и структура данных.

## Цели релиза v1
1. Вывести в прод «Ассистента мастера» как основной канал заявок: Telegram-бот с поиском, корзиной, оформлением заказов (prepaid и COD «Неси»), сопровождением возвратов и degraded mode.
2. Обеспечить наблюдаемость и устойчивость ассистента: единый формат ошибок, идемпотентность, rate limits, метрики/алерты и UAT пилота (golden-set, нагрузочные проверки, KPI).

> Перенесено после v1: поднимать middleware как «почтальона» между УТ 10.3 и УТ 11 (SoT=10.3), включая журнал интеграции и очереди повторов согласно SRS.

## Этапы и ключевые работы
### Этап 0. Подготовка инфраструктуры (неделя 0)
- Развёртывание окружений DEV→TEST→UAT→PROD с раздельными секретами и анонимизацией тестовых данных.
- Настройка CI/CD: blue‑green/rolling деплой FastAPI с health‑чеками и автооткатом при деградации SLO.
- Подготовка наблюдаемости: метрики задержек дельт, длины очередей, %5xx/%4xx, дубликатов/1000 POST; алерты warn (>10 мин) и crit (>30 мин, %5xx>0,1%/15 мин, очередь>10k).
- Организация менеджера секретов, TLS 1.2+, маскирование телефонов и адресов в логах; шифрование бэкапов.

### Этап 1. Ассистент мастера (недели 1–2)
- Собрать MVP Telegram-бота: голос/текст, маршруты `/find`, `/order`, `/bring`, `/cart`, `/myorders`, `/track`, `/return`, `/howto`, `/compat` в соответствии с PRD.
- Интегрировать бота с API сайта 1С-Битрикс: поиск карточек, прайс/остатки, создание заказов (prepaid и COD «Неси»), корзина, трекинг и RMA, соблюдая единый формат ошибок и идемпотентность.
- Настроить аутентификацию через Telegram Login Widget → JWT сайта, хранение X-User-Token и rate limits; внедрить логи, метрики и алерты (latency, error rate, no-result, COD-share, degraded_mode).
- Реализовать degraded mode (кэш выдачи, уведомления) и минимальные техподсказки (prompt-only) с CTA «Заказать комплект».
- Подготовить UAT пилота: golden-set на 100 запросов, нагрузочные проверки (500 запросов), happy-path COD-заказ, критерии KPI (CTR, конверсия, F1, SLA ответов).

### Этап 2. Core Sync, Walking Warehouse и cutover (недели 3–6)
- **Core Sync:** bulk‑загрузка НСИ (КД3) с протоколом несопоставленных записей, дельты НСИ с p95 ≤60 с; зеркалирование документов (заказ, реализация, поступление, перемещение, списание, оприходование, инвентаризация, возвраты) с временем появления в УТ 11 ≤120 с без дублей; синхронизация денег (ПКО/РКО/подотчёт) с контролем отчёта «Должен/Сдал» (дельта ≤0,3%); Idempotency‑Key (TTL 72 ч), очередь ретраев (1м→5м→15м→1ч→3ч→12ч, доставка ≤24 ч) и журнал интеграции (JSON, ts, correlation_id, статус, тело/хэш, retention ≥90/180 дн).
- **Walking Warehouse:** кнопка «Отправить в B24» (создание задачи ≤10 с, статус «Готов (B24)», TaskIdB24, Idempotency-Key, недоступность при самовывозе); операции «Положить в рюкзак» и продажа из рюкзака с обновлением остатков ≤60 с и подтверждением менеджером; курьерские возвраты с фото/гео-контролем, ячейкой «Возвраты», мастер возврата (КПП‑4) с поиском по IMEI/серии и антидублем; API `/api/v1/returns/{return_id}/reject` с идемпотентностью, уведомлением клиента и подзадачей в B24; политики фото/гео/скана.
- **Cutover и операционка:** миграция (snapshot КД3 → дельты → freeze → ночной cutover), план отката с переключением флага мастера и реплеем очередей; UAT (pass‑rate ≥98% за 7 дней, дельты p95 ≤120 с, мониторинг 48 ч, on‑call), отчёты («Рюкзак курьера», «Возвраты в пути/принятые», сверка «Деньги в пути»), проверка клиентских уведомлений и обучение менеджеров/курьеров (30-мин сессии, владельцы процессов, контрольная группа).

## Критерии готовности
- SLA дельт: НСИ ≤60 с, документы ≤120 с, ПКО ≤180 с; MW p95 ≤400 мс, throughput 50 rps (burst 100 rps ≤60 с).
- Доступность MW ≥99,9% (месяц, 43 мин простоя); RPO ≤5 мин, RTO ≤15 мин.
- Повторный вызов с тем же Idempotency‑Key возвращает исходный ответ без дубля.
- Контроль наличных: отчёт «Должен/Сдал» ≤0,3%; доставка «Готов → Отдан» быстрее на 20%, ≥95% доставок без возврата.
- Cutover сайта на УТ 11 проходит 48 ч без красных алертов; уведомления клиенту и создание подзадач после return_rejected ≤60 с.

## Риски и меры
- Дубли/расхождения — покрыты идемпотентностью, антидублями в БД и регулярными отчётами сверки.
- Сбои внешних систем — очереди/ретраи, разделение потоков, алерты warn/crit и on‑call.
- Кастом 10.3 — аудит, тестовый стенд, ночные переключения, готовый план отката.
- Человеческий фактор по наличным и возвратам — обязательные шаги, фото/гео‑контроль, обучение и эскалации для просроченных возвратов (>1 дня).
