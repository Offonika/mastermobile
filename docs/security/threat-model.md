# Threat Model

## Активы и цели защиты
- Данные заказов, возвратов, финансов и персональные данные курьеров/клиентов.
- Токены доступа (JWT), ключи вебхуков, Idempotency-Key.
- Журналы IntegrationLog и метрики наблюдаемости.

## Противники
| Тип | Возможности | Мотивация |
| --- | --- | --- |
| Внешний злоумышленник | Сетевые атаки, подбор токенов, подмена вебхуков | Кража ПДн, саботаж процессов доставки |
| Скомпрометированный интеграционный партнёр | Доступ к API, знание структур payload | Создание ложных документов, мошенничество |
| Внутренний сотрудник с избыточными правами | Доступ к БД и логам | Несанкционированное чтение/изменение данных |

## Границы доверия
1. **Публичный периметр**: входящие запросы от 1С и Bitrix24 → FastAPI слой.
2. **Внутренний периметр**: FastAPI ↔ воркеры ↔ PostgreSQL/Redis.
3. **Интеграции**: исходящие вебхуки/REST к 1С и Bitrix24.
4. **Наблюдаемость**: экспорт логов/метрик/трейсов во внешние системы.

## Угрозы и меры
| Угроза | Вектор | Митигирующие меры |
| --- | --- | --- |
| Несанкционированный доступ к API | Кража/подбор токена | JWT Bearer с ролями (`1c`, `courier`, `admin`), проверка `aud`, `iss`, короткий TTL (15 мин), обязательный refresh через доверенный backend; см. «00‑Core — Синхронизация документации», §2.6 |
| Запросы из непроверенных доменов | Браузерные клиенты с чужих origin | Строгий CORS allow-list для публичного API (переменная `CORS_ORIGINS`), принудительно применяется на уровне API Gateway/FastAPI middleware; мониторинг конфигурации |
| Повтор/подмена запроса | Реплей атак | `Idempotency-Key`, хранение ключей 72ч, `X-Request-Id` + журнал, HMAC-подпись вебхуков, ограничение окна времени (±5 мин) |
| Инъекции в payload | Некорректный JSON/CommerceML | Валидация схем (Pydantic), allow-list полей, экранирование SQL через ORM, лимиты размера тела |
| Brute-force/DoS | Высокая частота запросов | Rate limiting по IP/клиенту/роли, circuit breaker для интеграций, защита WAF/CDN |
| Утечка ПДн через логи | Неконтролируемые поля | Маскирование PII, строгий контроль полей `extra`, запрет вывода сырых payload в логи |
| Скомпрометированные сервисные аккаунты | Похищенные ключи | Хранение секретов в Secret Manager, ротация 90 дней, аудит доступа, MFA для админов |
| Эскалация прав | Ошибка в RBAC | Политика наименьших привилегий, ежеквартальный аудит ролей, тесты авторизации, использование feature-флагов |

## Доверенная обработка данных
- Все соединения обязаны использовать TLS 1.2+.
- Доступ к PostgreSQL/Redis ограничен по IP и ролям сервисных аккаунтов.
- Бэкапы шифруются и хранятся отдельно от основной инфраструктуры.

## Наблюдаемость и инциденты
- События безопасности отправляются в SIEM: неуспешные логины, 4xx/5xx всплески, изменения ролей.
- Runbooks содержат инструкции для реагирования, включая отзыв токенов, ротацию ключей и восстановление из бэкапов.
- Post-incident review обязателен с обновлением ADR/NFR при выявлении пробелов.

## Остаточные риски
- Зависимость от внешних систем (Bitrix24, 1С) для своевременной ротации ключей.
- Возможность временных утечек через интеграции, если партнёры не поддерживают маскирование.
- Человеческий фактор в управлении правами — требует регулярного обучения и контроля.
