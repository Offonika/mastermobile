PRD — Тексты звонков Bitrix24 (выгрузка текстов звонков за 60 дней)
Версия: v1.0.0 (синхронизировано с 00‑Core v1.3.1, API‑Contracts v1.1.0)
 Дата: 19.09.2025
 Владелец продукта: Операции / Call Center
Основано на: ONE-PAGER — «Тексты всех звонков за 60 дней из Bitrix24», 00‑Core v1.3.3 (Core‑API‑Style, Metrics & Alerts, Retention, Envs/Flags), API‑Contracts v1.1.0 (Bitrix24 интеграции), ER Freeze v0.6.5.

1) Резюме
Цель — зафиксировать процесс регулярной выгрузки аудиозаписей и текстов всех звонков Bitrix24 за последние 60 дней, автоматизировать распознавание речи и формирование артефактов (папка текстов, CSV‑реестр, отчёт по длительности и стоимости), обеспечить идемпотентность повторных запусков, контроль качества и прозрачность расходов. Решение строится на существующем MW‑контуре (FastAPI) с отдельным пайплайном: запрос звонков → скачивание аудио → распознавание → хранение текстов → отчёт и контроль.

2) Цели и KPI
2.1 Цели v1 (2 недели)
- Собрать 100% звонков Bitrix24 за выбранный период (по умолчанию последние 60 дней).
- Получить читабельные тексты для ≥ 98% успешно скачанных аудио.
- Сформировать CSV‑реестр с полями: datetime_start, direction, from, to, duration_sec, recording_url, transcript_path, transcription_cost, language, status.
- Выгрузить отчёт с суммарной длительностью (минуты) и итоговой стоимостью распознавания (руб./USD).

2.2 KPI / метрики успеха
- Покрытие звонков: ≥ 99% записей с доступным аудио имеют текст.
- Пропуски/ошибки: ≤ 1% звонков в статусе "ошибка" > 24 ч (алерт).
- Расхождение длительности реестра vs. Bitrix24: ≤ 0,5%.
- Дубли транскриптов: 0 на 1000 звонков.
- SLA пайплайна: полный проход периода 60 дней ≤ 6 часов (при параллельности 10) при среднем объёме 9 000 минут.

3) Scope, допущения и ограничения
In scope (v1):
- Обработка входящих/исходящих звонков с записями из Bitrix24 (REST API телефонии).
- Авто‑скачивание аудио (mp3/wav) и сохранение на защищённом storage (S3‑bucket/локальный шифрованный диск).
- Распознавание Whisper (OpenAI) или альтернативный сервис с совместимым API.
- Формирование текстовых файлов UTF‑8 (один файл на звонок) и CSV‑реестра.
- Короткий отчёт (markdown/pdf) с итогами длительности/стоимости + список исключений.
- Опциональная генерация кратких саммари/тегов (при включённом флаге).
- Повторные запуски без дублей (идемпотентность по call_id + record_id + period).

Out of scope (v1):
- Онлайн‑поток звонков (< real-time).
- Автоматический анализ содержания (кроме саммари по запросу).
- BI‑дашборды, интеграция в ChatGPT (поставляется отдельными шаблонами).
- Очистка исторических периодов > 90 дней.

Допущения:
- Доступ к Bitrix24 API с правами чтения звонков и скачивания записей (token OAuth/webhook).
- Whisper API доступен, квоты достаточны; стоимость списывается на корпоративный аккаунт.
- Исходящие обращения к ChatGPT/Whisper выполняются строго через корпоративный прокси `http://user150107:dx4a5m@102.129.178.65:6517` (переменная `CHATGPT_PROXY_URL`).
- Storage (S3/локальный) соответствует требованиям 00‑Core §9 (шифрование, retention).
- Записи звонков доступны минимум 90 дней с момента разговора.

Ограничения:
- Лимиты Bitrix24 (batch ≤ 50, rate-limit 2 rps/приложение); нужно бэкофф и очереди.
- Ограничение Whisper: 25 МБ / 15 мин на файл (при превышении — сегментация).
- Период выгрузки по умолчанию 60 дней; расширение требует согласования (ресурсы/стоимость).

4) Управление: решения и изменения
- Decision owner: Product (Операции/Call Center). SLA решений по scope/доступам — 1 рабочий день.
- Change control: изменения периода, сервиса распознавания, стоимости > ±10% или storage согласуются через CR (описание, влияние, новые KPI).
- Go/No-Go запуск: проверка доступа к Bitrix24, тестовый пайплайн на 5 звонков, подтверждение отчёта и ретеншн‑политики.
- Версионирование: конфигурация пайплайна хранится в репозитории (yaml), изменения проходят код‑review.

5) Архитектура и поток данных
5.1 Компоненты
- Scheduler (cron/ручной запуск) — инициирует задачу `calls_export`.
- MW Service (FastAPI + worker) — orchestrator пайплайна, хранит state в PostgreSQL (`call_exports`, `call_records`).
- Bitrix24 Client — REST API wrapper с ретраями (429/5xx) и backoff по 00‑Core §8.
- Storage Adapter — сохраняет аудио и тексты (S3 с server-side encryption, либо шифрованный каталог).
- Speech-to-Text Adapter — интеграция с Whisper (async uploads, chunking > 15 мин).
- Reporter — формирует CSV и отчёт (Jinja2 шаблон, Markdown → PDF по необходимости).
- QA Module — выборочный контроль (50 файлов, сверка длительностей).

5.2 Поток данных
1. Инициация: оператор выбирает период (default `today-60d` .. `today`) и флаги (`generate_summary=true/false`).
2. MW запрашивает у Bitrix24 список звонков (batched, сортировка по start_time desc). State сохраняется для повторных запусков.
3. Для каждого звонка с записью скачивается файл по `record_url`. При ошибке — до 5 повторов с экспоненциальным бэкоффом; статусы фиксируются.
4. Аудио кладётся в storage `/raw/YYYY/MM/DD/call_<id>.mp3`, в БД сохраняются checksum и путь.
5. Транскрипция: аудио отправляется в Whisper → полученный текст нормализуется (язык, пунктуация, таймкоды опц.) и сохраняется `transcripts/call_<id>.txt` (UTF‑8, BOM отсутствует).
6. Стоимость рассчитывается: `minutes_rounded_up * price_per_minute` (по тарифу сервиса). Значения пишутся в БД/CSV.
7. CSV‑реестр и отчёт формируются после завершения всех задач или по завершении каждой пачки (streaming writer) — файл `registry/calls_<from>_<to>.csv`.
8. Отчёт включает агрегаты (минуты, стоимость, успех/ошибки), список пропусков, прогноз расходов, время выполнения.
9. При включении саммари: GPT‑шаблон обрабатывает текст и формирует `summary/call_<id>.md` + теги, добавляется в CSV.
10. Пайплайн завершает run и помечает state как `completed`; при повторном запуске по тому же периоду скачиваются только отсутствующие записи/транскрипты (идемпотентность).

6) Артефакты и данные
- Папка выдачи `exports/<period>/` с подпапками `raw/`, `transcripts/`, `summary/` (опц.), `reports/`.
- CSV‑реестр (UTF‑8, ;‑разделитель): обязательные поля перечислены в §2.1; доп. поля — `summary_path` (если саммари), `error_code`, `retry_count`.
- Отчёт `reports/summary_<period>.md` (и PDF при необходимости) — содержит: общий объём минут, стоимость, пропуски, рекомендации.
- Журнал `logs/call_export_<timestamp>.jsonl` — трассировка операций с `correlation_id`, `call_id`, `event`.
- Хранение state: PostgreSQL таблицы `call_exports` (run_id, period_from/to, status, started_at, finished_at, actor) и `call_records` (run_id, call_id, record_id, duration_sec, recording_url, transcript_path, checksum, cost, status, error_message, attempts).

7) Функциональные требования (эпики → DoD)
F1. Импорт звонков Bitrix24.
 DoD: API запрашивается с учётом пагинации/фильтров; повторный запуск без очистки state не создаёт дублей; состояние API‑лимитов логируется.
F2. Скачивание и хранение аудио.
 DoD: 100% файлов доступны на storage; контрольная сумма совпадает при повторном скачивании; битые ссылки помечаются статусом `missing_audio`.
F3. Распознавание речи.
 DoD: ≥ 98% файлов успешно транскрибированы; язык определяется корректно (в CSV поле `language`); ошибки (timeout, 4xx) ретраятся и попадают в отчёт.
F4. Формирование текстов и CSV.
 DoD: текстовые файлы соответствуют структуре (заголовок с метаданными, тело диалога по ролям); CSV валиден и открывается в Excel/Numbers; все поля заполнены.
F5. Отчёт и стоимость.
 DoD: отчёт содержит суммарную длительность (мин/ч) и стоимость; расхождение длительности с Bitrix24 ≤ 0,5%; список пропусков приложен.
F6. Опциональные саммари и теги.
 DoD: при включённом флаге формируются файлы саммари, в CSV появляются `summary_path` и `tags`; отсутствуют для вызовов со статусом ошибка.
F7. Идемпотентность и повторные запуски.
 DoD: повтор с тем же периодом не создаёт дублей, недостающие записи догружаются, частично обработанные звонки перезапускаются с шага ошибки; запуск `/tasks/call_export` принимает заголовок `Idempotency-Key` (UUID, один ключ на run) и при повторе с тем же ключом возвращает сохранённый ответ, а записи внутри run защищены уникальным ключом `(run_id, call_id, record_id)`.

8) Нефункциональные требования
- Объём: целевой период 60 дней ≈ 9 000 минут (при 150 звонках/день по 10 мин максимум). Система выдерживает до 20 000 минут / run без деградации.
- Производительность: параллельная обработка до 10 звонков (configurable). Пайплайн 60‑дневного периода завершается ≤ 6 ч (p95) при Whisper latency ≤ 30 c/мин.
- Ретраи: Bitrix24 — 5 попыток с backoff 5/15/30/60/120 c; Whisper — 3 попытки с 10/30/60 c.
- Хранение: raw‑аудио 90 дней (по 00‑Core §9), транскрипты и отчёты 180 дней, после чего архив/удаление.
- Стоимость: формула `minutes_total * тариф`. Whisper базовый тариф $0,006/мин; прогноз для 9 000 мин ≈ $54 (5 400 ₽ по курсу 100). Budget alert при отклонении > 20%.
- Доступность: MW сервис ≥ 99,5% (наследует требования 00‑Core §2.7). Восстановление после сбоя — рестарт пайплайна с последнего checkpoint (<5 мин).
- Масштабирование: конфиги хранятся в `.env`/feature flag (`EXPORT_SUMMARY_ENABLED`).

9) Наблюдаемость, мониторинг и алерты
- Метрики Prometheus: `call_export_runs_total{status}`, `call_transcripts_total{status}`, `call_export_duration_seconds`, `call_transcription_minutes_total`, `call_export_cost_total`, `call_export_retry_total`.
- Алерты:
  - run_status = error > 15 мин → crit (paging on-call).
  - `call_transcripts_total{status="error"}` > 1% от processed за 30 мин → warn.
  - `call_export_cost_total` > budget_threshold → warn (email/Slack).
  - Лимиты Bitrix24 (`429`) > 10 за 15 мин → warn, переключение в low‑rate режим.
- Логи: JSON (`event`, `call_id`, `stage`, `duration_ms`, `error_code`, `correlation_id`). PII (номера телефонов) маскируются.
- Runbook: [Выгрузка звонков Bitrix24](runbooks/call_export.md) — оперативные действия, мониторинг и ретраи.
- Дашборды: Grafana панели для статусов, длительности, стоимости, успех/ошибка. QA панель — выборка проверенных файлов.

10) Безопасность, ПДн и соответствие 00‑Core
- Аутентификация: сервисные учётки с ограниченными scope (чтение звонков). Token хранится в Secret Manager, ротация ≤ 90 дней.
- Сетевой доступ: исходящие вызовы только к Bitrix24 и Whisper; storage в приватной сети.
- Шифрование: данные в пути — HTTPS/TLS 1.2+; данные на storage — AES‑256 (server-side) + контроль доступа RBAC.
- ПДн: транскрипты содержат персональные данные (ФИО, номера). Доступ только роли `Call Center Analyst`, `Operations`. Выгрузка по запросу фиксируется в журнале аудита.
- Retention: raw — 90 дней, transcripts/report — 180 дней, CSV — 365 дней (при необходимости для аналитики), затем безвозвратное удаление (см. 00‑Core §9).
- DR/BCP: бэкап storage и БД ежесуточно; RPO ≤ 24 ч, RTO ≤ 4 ч.

11) План тестирования и QA
- Unit/Integration тесты: мок Bitrix24 (respx), мок Whisper; проверка идемпотентности, ретраев, error handling.
- Test plan v1:
  - Smoke: выгрузка 5 звонков → все артефакты сформированы, отчёт соответствует.
  - Regression: run на период 2 дня (≈ 300 звонков) → покрытие ≥ 99%, время выполнения фиксируется.
  - QA выборка: вручную проверяем 50 файлов (читаемость, соответствие диалога, язык).
  - Сверка длительности: сравниваем суммарные секунды CSV с отчётом Bitrix24 (расхождение ≤ 0,5%).
  - Проверка саммари (если включены): 10 выборочных звонков → адекватность содержания, отсутствие ПДн за пределами правила.
  - Negative: битая ссылка (404) → статус `missing_audio`, отражён в отчёте; таймаут Whisper → повторный запуск без дубля.
- Acceptance checklist: все тесты зелёные, отчёт доставлен заказчику, алерты настроены.

12) План запуска и эксплуатация
- Подготовка: получить доступы Bitrix24 и Whisper, настроить storage, создать сервисные учётки.
- Dry-run: период 7 дней, контроль QA (50 файлов), доработка конфигов.
- Production run: полные 60 дней, мониторинг в реальном времени, отчёт через 24 ч после старта.
- Go-live критерии: покрытие ≥ 99%, отчёт утверждён Product, алерты зелёные 48 ч.
- Операции: запуск планируется еженедельно/ежемесячно (cron). Ответственный — DataOps.
- Обратная связь: канал #call-texts, статусы еженедельно, ретроспектива ежемесячно.

13) Роли и доступы
- Product Owner (Операции/Call Center) — приоритеты, подтверждение отчётов.
- Data Engineer — поддержка пайплайна, мониторинг.
- QA Analyst — выборочный контроль качества, UAT.
- Security Officer — контроль ПДн, аудит доступа.
- Stakeholders: Руководитель продаж, Аналитики, Операторы контакт‑центра.
- Доступы: Bitrix24 API (read), Whisper API key, S3 bucket, MW logs (read-only), Grafana dashboard.

14) Риски и меры
- Недоступность Bitrix24 / истёкший токен — мониторинг 401/403, алерт, playbook по обновлению токена.
- Превышение лимитов Bitrix24 — адаптивный rate-limit, кэширование списков звонков по дням.
- Утечки ПДн — строгий доступ, шифрование, аудит, удаление после retention.
- Стоимость > бюджета — предиктивный расчёт перед запуском, алерт при превышении > 20%.
- Длинные звонки > 15 мин — сегментация аудио, объединение транскриптов, контроль таймкодов.
- Ошибки распознавания (язык, шум) — fallback модель (ru-large/v2), ручная пометка проблемных звонков.
- Хранение на локальном диске → переполнение — мониторинг свободного места, авто‑очистка после retention.

15) Критерии приёмки (DoD)
- Пайплайн успешно обрабатывает 60‑дневный период, coverage ≥ 99%.
- CSV‑реестр содержит все обязательные поля, валиден и импортируется в Google Sheets / Excel без ошибок.
- Расхождение длительности vs Bitrix24 ≤ 0,5%; стоимость соответствует тарифу.
- Папка с текстами содержит файлы без дублей; повторный запуск не создаёт повторных транскриптов.
- QA‑выборка (50 файлов) подтверждена; дефекты устранены либо задокументированы (< 2% критичных).
- Алерты и дашборды настроены; on-call знает playbook.
- Документация (readme, runbook) обновлена, ссылки на шаблоны ChatGPT приложены.

16) Приложения и ссылки
- A1. Шаблон запроса ChatGPT для саммари (OneDrive/Notion, ссылка в runbook).
- A2. OpenAPI anchors Bitrix24 телефонии (см. API‑Contracts v1.1.0, раздел `b24.telephony.calls.*`).

- A3. Runbook инцидентов: [docs/runbooks/call_export.md](runbooks/call_export.md) — доступен к использованию.
- A4. Формат CSV (data dictionary) — [docs/specs/call_registry_schema.yaml](specs/call_registry_schema.yaml).

