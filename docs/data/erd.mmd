erDiagram
    %% Возвраты и связанные артефакты наблюдаемости
    RETURNS {
        uuid return_id PK "Первичный ключ (генерируется MW)"
        text order_id_1c "Ссылка на исходный документ 1С (nullable)"
        text courier_id "Курьер, оформивший возврат"
        text manager_id "Оператор, подтвердивший возврат (nullable)"
        text source "Канал инициации: widget|call_center|warehouse"
        text status "Статус: pending|accepted|rejected|cancelled"
        text comment "Комментарий оператора (nullable)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    RETURN_LINES {
        bigserial id PK "Технический идентификатор строки"
        uuid return_id FK "FK → returns.return_id"
        text line_id "Идентификатор строки в исходном документе"
        text sku "SKU возвращаемого товара"
        integer qty "Количество (CHECK qty > 0)"
        text quality "Качество: new|defect|unknown"
        text reason_code "Код причины из справочника"
        text reason_note "Текстовая расшифровка причины (nullable)"
        jsonb photos "Массив ID файлов Bitrix24 (nullable)"
        text imei "IMEI устройства (nullable)"
        text serial "Серийный номер (nullable)"
    }

    INTEGRATION_LOG {
        bigserial id PK "Журнал записи"
        timestamptz ts "Момент вызова/ответа (UTC)"
        text direction "Направление: inbound|outbound"
        text external_system "Внешняя система: 1c|b24|warehouse"
        text endpoint "REST-метод или шина"
        text status "Статус обработки: success|error|retry"
        integer status_code "HTTP/бизнес-статус результата"
        text correlation_id "X-Correlation-Id для трассировки"
        text resource_ref "Ссылка на сущность (например, return_id)"
        jsonb request "Нормализованное тело запроса"
        jsonb response "Нормализованное тело ответа"
        text error_code "Код ошибки (nullable)"
        integer retry_count "Ретраи (nullable)"
    }

    TASK_EVENTS {
        bigserial id PK "Суррогатный ключ события"
        text task_id_b24 "Связанная задача Bitrix24"
        uuid return_id FK "FK → returns.return_id (nullable, события ветки возврата)"
        timestamptz ts "Момент события (UTC)"
        text type "Тип: status|photo|geo|comment"
        text status "Статус задачи после события (nullable)"
        text actor_id "Курьер/система инициатор"
        jsonb payload_json "Полный payload события"
        text correlation_id "CorrelationId (уникальный, nullable)"
    }

    CALL_EXPORTS {
        uuid run_id PK "Идентификатор запуска (UUID)"
        timestamptz period_from "Начало периода выгрузки (UTC)"
        timestamptz period_to "Конец периода выгрузки (UTC)"
        text status "Статус: pending|in_progress|completed|error|cancelled"
        timestamptz started_at "Старт запуска (UTC)"
        timestamptz finished_at "Завершение запуска (UTC, nullable)"
        uuid actor_user_id FK "FK → core.users.user_id (nullable, инициатор)"
        jsonb options "Флаги запуска (generate_summary, language и др.)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    CALL_RECORDS {
        bigserial id PK "Технический идентификатор"
        text run_id FK "FK → call_exports.run_id"
        text call_id "Идентификатор звонка в Bitrix24"
        text record_id "Идентификатор записи"
        timestamptz started_at "Начало звонка (UTC)"
        text direction "Направление: inbound|outbound|internal"
        text employee_id "Идентификатор оператора (nullable)"
        text from_number "Номер клиента (E.164, CHECK not blank)"
        text to_number "Номер оператора (CHECK not blank)"
        integer duration_sec "Длительность (сек, CHECK ≥ 0)"
        text recording_url "Исходный URL записи"
        text storage_path "Путь к сохранённому аудио (nullable)"
        text transcript_path "Путь к расшифровке (nullable)"
        text summary_path "Путь к саммари (nullable)"
        text text_preview "Первые 1 кБ текста (nullable)"
        text language "Определённый язык (nullable)"
        text checksum "Контрольная сумма аудио (nullable)"
        numeric transcription_cost "Стоимость распознавания (nullable)"
        currency_code currency_code "Валюта стоимости (ISO-4217)"
        text status "Статус: pending|downloading|downloaded|transcribing|completed|skipped|error|missing_audio"
        text error_code "Код ошибки (nullable)"
        text error_message "Описание ошибки (nullable)"
        integer retry_count "Количество повторов (CHECK ≥ 0)"
        timestamptz last_retry_at "Последний повтор (UTC, nullable)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    RETURNS ||--o{ RETURN_LINES : "содержит"
    RETURNS ||--o{ INTEGRATION_LOG : "логирует через resource_ref"
    RETURNS ||--o{ TASK_EVENTS : "формирует события"
    CALL_EXPORTS ||--o{ CALL_RECORDS : "агрегирует"
