erDiagram
    %% ER Freeze v0.6.4 — фактические сущности из docs/ER‑диаграмма и DDL.md
    %% Схема core
    RETURNS {
        uuid return_id PK "Первичный ключ (генерируется MW)"
        text order_id_1c "Ссылка на исходный документ 1С (nullable)"
        text courier_id "Курьер, оформивший возврат"
        text manager_id "Оператор, подтвердивший возврат (nullable)"
        text source "Канал инициации: widget|call_center|warehouse"
        text status "Статус: pending|accepted|rejected|cancelled"
        text comment "Комментарий оператора (nullable)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    RETURN_LINES {
        bigserial id PK "Технический идентификатор строки"
        uuid return_id FK "FK → returns.return_id"
        text line_id "Идентификатор строки в исходном документе"
        text sku "SKU возвращаемого товара"
        integer qty "Количество (CHECK qty > 0)"
        text quality "Качество: new|defect|unknown"
        text reason_code "Код причины из справочника"
        text reason_note "Текстовая расшифровка причины (nullable)"
        jsonb photos "Массив ID файлов Bitrix24 (nullable)"
        text imei "IMEI устройства (nullable)"
        text serial "Серийный номер (nullable)"
    }

    INTEGRATION_LOG {
        bigserial id PK "Журнал записи"
        timestamptz ts "Момент вызова/ответа (UTC)"
        text direction "Направление: inbound|outbound"
        text external_system "Внешняя система: 1c|b24|warehouse"
        text endpoint "REST-метод или шина"
        text status "Статус обработки: success|error|retry"
        integer status_code "HTTP/бизнес-статус результата"
        text correlation_id "X-Correlation-Id для трассировки"
        text resource_ref "Ссылка на сущность (например, return_id)"
        jsonb request "Нормализованное тело запроса"
        jsonb response "Нормализованное тело ответа"
        text error_code "Код ошибки (nullable)"
        integer retry_count "Ретраи (nullable)"
    }

    TASK_EVENTS {
        bigserial id PK "Суррогатный ключ события"
        text task_id_b24 "Связанная задача Bitrix24"
        uuid return_id FK "FK → returns.return_id (nullable, события ветки возврата)"
        timestamptz ts "Момент события (UTC)"
        text type "Тип: status|photo|geo|comment"
        text status "Статус задачи после события (nullable)"
        text actor_id "Курьер/система инициатор"
        jsonb payload_json "Полный payload события"
        text correlation_id "CorrelationId (уникальный, nullable)"
    }

    IDEMPOTENCY_KEY {
        uuid key PK "Ключ идемпотентности"
        text endpoint "Нормализованный endpoint"
        text actor_id "Отправитель (курьер/1С/system)"
        text scope "Логическая область операции"
        text resource_ref "Связанная сущность (nullable)"
        jsonb response_snapshot "Кешированный ответ (nullable)"
        timestamptz created_at "Создано (UTC)"
        timestamptz expires_at "Истекает (UTC, TTL 72h)"
    }

    ORDERS {
        uuid order_id PK "Заказ доставки (MW UUID)"
        text task_id_b24 "Связь с задачей Bitrix24 (nullable)"
        text status "Status-Dictionary v1"
        numeric delivery_price "Стоимость доставки"
        numeric cod_amount "Сумма COD (nullable)"
        char(3) currency_code "Валюта (ISO-4217, по умолчанию RUB)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
        text phone "Телефон клиента (маскируется в логах)"
    }

    ORDER_LINES {
        bigserial id PK "Строка заказа"
        uuid order_id FK "FK → orders.order_id"
        text sku "SKU товара"
        integer qty "Количество"
        numeric price "Цена"
        numeric vat_rate "Ставка НДС"
    }

    %% Схема walking warehouse (ww)
    COURIERS {
        uuid courier_id PK "UUID курьера"
        text external_id "Идентификатор 1С/Bitrix"
        text status "Статус в системе"
        text phone "Телефон (маскируется)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    COURIER_STOCK {
        bigserial id PK "Строка остатка"
        uuid courier_id FK "FK → couriers.courier_id"
        text sku "SKU товара"
        integer qty "Количество на руках"
        timestamptz updated_at "Обновлено (UTC)"
    }

    INSTANT_ORDERS {
        uuid instant_order_id PK "UUID мгновенного заказа"
        uuid courier_id FK "FK → couriers.courier_id"
        text task_id_b24 "Связанная задача Bitrix24"
        text status "Status-Dictionary v1"
        numeric total_amount "Сумма по заказу"
        char(3) currency_code "Валюта (ISO-4217)"
        timestamptz created_at "Создано (UTC)"
        timestamptz updated_at "Обновлено (UTC)"
    }

    INSTANT_ORDER_LINES {
        bigserial id PK "Строка мгновенного заказа"
        uuid instant_order_id FK "FK → instant_orders.instant_order_id"
        text sku "SKU товара"
        integer qty "Количество"
        numeric price "Цена"
        numeric discount "Скидка (nullable)"
    }

    RETURNS ||--o{ RETURN_LINES : "содержит"
    RETURNS ||--o{ INTEGRATION_LOG : "логируется через resource_ref"
    RETURNS ||--o{ TASK_EVENTS : "создаёт события"
    IDEMPOTENCY_KEY ||--o{ INTEGRATION_LOG : "дедупликация вызовов"
    ORDERS ||--o{ ORDER_LINES : "содержит"
    COURIERS ||--o{ INSTANT_ORDERS : "оформляет"
    INSTANT_ORDERS ||--o{ INSTANT_ORDER_LINES : "содержит"
    COURIERS ||--o{ COURIER_STOCK : "держит остатки"
